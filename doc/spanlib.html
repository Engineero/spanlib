<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>SpanLib - Spectral Analysis Library</title>
    <meta name="generator" content="DocBook XSL Stylesheets V1.69.1" />
    <meta name="keywords" content="statistics, physics, climate variability, financial variability, FFT, eigen problem, spatio-temporal, MSSA, Multichannel singular spectrum analysis, PCA, Principal component analysis, EOF, Empirical othogonal funtion, PC, Principal component, SVD, Singular value decomposition, POP, Principal oscillation patterns" />
    <style xmlns="" type="text/css">
			/* Main */
body {
	padding-right:30px;
	background-color:white;
}

/* Shadow */
h1 {
	text-shadow: #999 0.1em 0.1em 3px;
}
h2, h3, h4, h5, div.navfooter, div.navheader {
	text-shadow: #999 0.1em 0.1em 2px;
}

/* Links */
a:link {
	color:inherit;
	text-decoration:underline;
}
a:hover {
	color:inherit;
	text-decoration:none;
	background-color:#eee;
}
a:visited {
	color:inherit;
	text-decoration:underline;
}

/* Titles */
h1 {text-align:center;}

/* Code */
pre.programlisting {
	border:1px dashed black;
	background-color:#eef;
	padding:5px;
	font-size:10px;
}

/* Special words */
h4 tt.literal,h4 a tt.literal, tt.varname  {color:blue;}

/* Syntax highlighting */
.HLpersonalised			{color:blue;}
.HLcomments					{color:#666;font-style:italic;}
.HLdigits					{color:red;}
.HLstrings					{color:#a80;}
.HLspecial					{color:green;}
.HLfunctions				{color:#077;}
.HLroutines,.HLcommands	{color:#a0a;}

/* Arguments */
.ARGspec		{font-weight:bold;font-size:10px;}
/*.ARGspec		{border-width:0;font-variant:small-caps;font-size:5px;}*/
.ARGname		{color:blue;}
/*.ARGlond_name	{padding-left:30px;}*/

/* My footer */
div.generated {
	font-size:8pt;
	font-style:italic;
}

/* Misc */
div.authorgroup div.affiliation div.address {font-size:10px}
div.note h3.title {font-size:smaller;}
.term {font-weight:bold;}

		</style>
  </head>
  <body>
    <div class="article" lang="en" xml:lang="en">
      <div class="titlepage">
        <div>
          <div>
            <h1 class="title"><a id="id2921559"></a>SpanLib - Spectral Analysis Library</h1>
          </div>
          <div>
            <div class="authorgroup">
              <div class="author">
                <h3 class="author"><span class="firstname">Stéphane</span> <span class="surname">Raynaud</span></h3>
              </div>
              <div class="author">
                <h3 class="author"><span class="firstname">Charles</span> <span class="surname">Doutriaux</span></h3>
              </div>
              <div class="affiliation">
                <div class="address">
                  <p>Contact: <code class="email">&lt;<a href="mailto:stephane dot raynaud at gmail dot com">stephane dot raynaud at gmail dot com</a>&gt;</code><br />
				</p>
                </div>
              </div>
            </div>
          </div>
          <div>
            <p class="releaseinfo">
			</p>
            <p>Version 1.2</p>
            <p class="releaseinfo">
			</p>
            <p>
				Project hosted by:
				<a href="http://sourceforge.net" target="_top">
					<div><table border="0" summary="manufactured viewport for HTML img" cellspacing="0" cellpadding="0" width="88"><tr><td><img src="http://sflogo.sourceforge.net/sflogo.php?group_id=168272&amp;type=1" width="88" /></td></tr></table></div>
				</a>
			</p>
            <p class="releaseinfo">
		</p>
          </div>
          <div>
            <fo:block xmlns:fo="http://www.w3.org/1999/XSL/Format">This documentation was generated on 11 January 2007</fo:block>
          </div>
        </div>
        <hr />
      </div>
      <div class="toc">
        <p>
          <b>Table of Contents</b>
        </p>
        <dl>
          <dt>
            <span class="sect1">
              <a href="#doc_pre">1. Presentation</a>
            </span>
          </dt>
          <dd>
            <dl>
              <dt>
                <span class="sect2">
                  <a href="#doc_pre_int">1.1. Introduction</a>
                </span>
              </dt>
              <dt>
                <span class="sect2">
                  <a href="#doc_pre_fun">1.2. Fundamentals</a>
                </span>
              </dt>
              <dt>
                <span class="sect2">
                  <a href="#doc_pre_tec">1.3. Some technical details...</a>
                </span>
              </dt>
              <dt>
                <span class="sect2">
                  <a href="#doc_pre_mor">1.4. For more information</a>
                </span>
              </dt>
              <dt>
                <span class="sect2">
                  <a href="#doc_int_vie">1.5. View colorized sources</a>
                </span>
              </dt>
            </dl>
          </dd>
          <dt>
            <span class="sect1">
              <a href="#doc_ins">2. Installation</a>
            </span>
          </dt>
          <dd>
            <dl>
              <dt>
                <span class="sect2">
                  <a href="#doc_ins_req">2.1. Requirements</a>
                </span>
              </dt>
              <dt>
                <span class="sect2">
                  <a href="#doc_ins_dow">2.2. Download</a>
                </span>
              </dt>
              <dt>
                <span class="sect2">
                  <a href="#doc_ins_ins">2.3. Compilation and installation</a>
                </span>
              </dt>
            </dl>
          </dd>
          <dt>
            <span class="sect1">
              <a href="#doc_f90">3. The Fortran 90 library</a>
            </span>
          </dt>
          <dd>
            <dl>
              <dt>
                <span class="sect2">
                  <a href="#doc_f90_int">3.1. Introduction</a>
                </span>
              </dt>
              <dt>
                <span class="sect2">
                  <a href="#doc_f90_sub">3.2. F90 subroutines</a>
                </span>
              </dt>
              <dt>
                <span class="sect2">
                  <a href="#doc_f90_exa">3.3. Fortran 90 examples</a>
                </span>
              </dt>
            </dl>
          </dd>
          <dt>
            <span class="sect1">
              <a href="#doc_pyt">4. The python module</a>
            </span>
          </dt>
          <dd>
            <dl>
              <dt>
                <span class="sect2">
                  <a href="#doc_pyt_int">4.1. Introduction</a>
                </span>
              </dt>
              <dt>
                <span class="sect2">
                  <a href="#doc_pyt_sub">4.2. Python functions</a>
                </span>
              </dt>
              <dt>
                <span class="sect2">
                  <a href="#doc_pyt_exa">4.3. Python examples</a>
                </span>
              </dt>
            </dl>
          </dd>
          <dt>
            <span class="sect1">
              <a href="#doc_lin">5. Links</a>
            </span>
          </dt>
          <dt>
            <span class="bibliography">
              <a href="#doc_bib">Bibliography</a>
            </span>
          </dt>
        </dl>
      </div>
      <div class="sect1" lang="en" xml:lang="en">
        <div class="titlepage">
          <div>
            <div>
              <h2 class="title" style="clear: both"><a id="doc_pre"></a>1. Presentation</h2>
            </div>
          </div>
        </div>
        <div class="sect2" lang="en" xml:lang="en">
          <div class="titlepage">
            <div>
              <div>
                <h3 class="title"><a id="doc_pre_int"></a>1.1. Introduction</h3>
              </div>
            </div>
          </div>
          <p>
				Observed or simulated multi-channel timeseries generally include
				a sum of different signals that can be hardly distinguished one another,
				even if their respective origin is fundamentally different.
				Analysis methods that are able to extract the most coherent modes
				of variability generally help to identify signals of interests.
			</p>
          <p>
				SpanLib currently focuses on the use of linear analysis methods
				that rely on eign solutions of covariance or correlation matrices
			</p>
          <p>
				This package provides a <a href="#doc_f90" title="3.&#xA0;The Fortran 90 library">F90 library</a> (as a module)
				containing a minimal collection of subroutines to perform
				<span class="bold"><strong>Principal Componant Analysis</strong></span> (PCA),
				<span class="bold"><strong>Multi-channel Singular Spectrum Analysis</strong></span> (MSSA),
				<span class="bold"><strong>Singular Value Decomposition</strong></span> (SVD),
				reconstruction of components and phase composites.
				The package also provide a <a href="#doc_pyt" title="4.&#xA0;The python module">python module</a>
				that calls the F90 library and gives the user a set of useful functions
				to perform analyses.
			</p>
          <p>
				In its future version, SpanLib will also include others methods
				(such as Principal Oscillation Pattern analysis) and languages
				(C, Java).
			</p>
        </div>
        <div class="sect2" lang="en" xml:lang="en">
          <div class="titlepage">
            <div>
              <div>
                <h3 class="title"><a id="doc_pre_fun"></a>1.2. Fundamentals</h3>
              </div>
            </div>
          </div>
          <p>
				<span class="bold"><strong><a href="#pca">PCA</a></strong></span> is also know as Empirical Orthogonal Functions (EOFs) decomposition:
				it decomposes a space-time signal in pairs of
				spatial EOFs and temporal
				Principal Components (PCs)
				that are the eigen solutions of the covariance (or correlation) matrix of the initial signal.
				The first EOFs represent the dominant, pure spatial patterns of variability,
				and their associated PCs are the coefficients that regulate these patterns.
				</p>
          <div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3>
					In this document, "space" refers to the more general notion
					of "channel",  in opposition to "time".
					In climate studies, the channel dimension generally coincides with space.
				</div>
          <p>
			</p>
          <p>
				<span class="bold"><strong><a href="#ssa">SSA</a></strong></span> (Singular Spectrum Analysis)
				is mathematically very similar to PCA:
				there is now only one channel as an input dataset, and eigenmodes are computed on
				the lag-covariance matrix (instead of on the cross -between channels- covriance matrix).
				The EOFs have only a temporal dimension.
				Therefore, SSA is intended to provides information on purely temporal signal, like
				a classical Fourier decomposition.
				However, SSA has many advantages on the latter method:
				</p>
          <div class="itemizedlist">
            <ul type="disc">
              <li>
						It removes <span class="emphasis"><em>incoherent noise</em></span> (white noise):
						the noisy part of the signal takes the form of low order
						modes, identified as a "background" that can be easily neglected.
					</li>
              <li>
						It naturally extracts <span class="emphasis"><em>regular oscillations</em></span> (with a narrow spectral peak).
						These oscillations are identified as pair of modes whose PCs and EOFs
						are in phase quadrature, that can be <span class="emphasis"><em>intermittent</em></span>.
					</li>
              <li>
						Coherent nonlinear trends are identified as the lower frequency modes.
					</li>
              <li>
						Compared to others, this method is efficient on short signal.
					</li>
            </ul>
          </div>
          <p>
				The maximal lag (the only parameter of SSA) is known as the
				<a href="#window" title="The window parameter">window</a>.
			</p>
          <p>
				<span class="bold"><strong><a href="#mssa">MSSA</a></strong></span>
				is a combination of PCA and SSA: it is an SSA on several channels.
				The diagonalized is built on covariances between channels (cross) and time segments (lag).
				Therefore, it has the advantage of PCA for extracting the dominant "spatial" patterns
				of the variability, and has also the spectral filtering capabilities of SSA.
				All identified modes have spatio-temporal properties.
				For example, oscillations are not constrained on a fixed spatial pattern, but can also
				have a <span class="emphasis"><em>propagative signature</em></span> over their cycle.
				<span class="emphasis"><em>This advanced spatial and spectral filtering is helpful to identify
				the most coherent (and more especially oscillatory) spatio-temporal modes in a short
				noisy signal.</em></span>
			</p>
          <p>
				<span class="bold"><strong><a href="#svd">SVD</a></strong></span>
				works in a similar way to PCA, except that two different dataset are
				decomposed at the same time.
				Therefore, the diagonalyzed matrix is a cross-covariance matrix and
				may not be symetric and positive.
				Dominant EOFs and PCs can be used for example to build a statiscal
				model linking the second variable to the first one.
			</p>
          <p>
				All these analysis methods act as a linear filter.
				For each of them, it is possible to reconstruct part of the filtered signal.
				A reconstructed mode is the "multiplication" of its EOF by its PC, and
				it has the same dimension of the initial dataset.
				Such operation is necessary to go back from the EOF space to the physical space.
			</p>
          <p><a id="pg:dof"></a>
				Finally, PCA may be used also to simply reduce the number of degree-of-freedom (d-o-f) of a dataset.
				For example, you can keep the first PC that explain a 70% of the variance.
				These PCs are then used as an input dataset for other analysis.
				This methodology is useful for MSSA and SVD since the eigen problem solving
				may be very time consuming: we are now able, for example, to potentially reduce the
				number of channels from several hundred or thounsand, to less than 20.
			</p>
        </div>
        <div class="sect2" lang="en" xml:lang="en">
          <div class="titlepage">
            <div>
              <div>
                <h3 class="title"><a id="doc_pre_tec"></a>1.3. Some technical details...</h3>
              </div>
            </div>
          </div>
          <div class="sect3" lang="en" xml:lang="en">
            <div class="titlepage">
              <div>
                <div>
                  <h4 class="title"><a id="doc_pre_tec_pca"></a>1.3.1. ...about PCA</h4>
                </div>
              </div>
            </div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="id2972989"></a>CPU: space versus time</h5>
                  </div>
                </div>
              </div>
              <p>
						PCA decomposition is performed on spatio-temporal datasets.
						If the number of channels becomes important, PCA can use a lot of CPU since
						the size of the diagonalised matrix if to the square of this number.
						It is possible to partly avoid this problem when the time dimension is lower
						than the spatial dimension, using a correlation matrix
						in time instead of in space.
						F90 subroutine <code class="varname"><a href="#sl_pca" title="3.2.1.&#xA0;: sl_pca">sl_pca</a></code> of SpanLib
						provides the ability
						to choose which of theses approaches to use for PCA.
					</p>
            </div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="id2973017"></a>Weights</h5>
                  </div>
                </div>
              </div>
              <p>
						In some case, not all channels have the same weight.
						For instance, for gridded dataset, weight must be proportional
						to the grid cell area.
						Whereas common PCA analysis does not take these weights into account
						it is possible to give optional weights to
						<code class="varname"><a href="#sl_pca" title="3.2.1.&#xA0;: sl_pca">sl_pca</a></code>.
						Using the <a href="#doc_pyt" title="4.&#xA0;The python module">python module</a>,
						it is easy to "attach" weights to a variable for use by
						<code class="varname"><a href="#&lt;SpAn_object&gt;.pca" title="4.2.6.&#xA0; Principal Components Analysis (PCA): &lt;SpAn_object&gt;.pca">pca</a></code>.
					</p>
            </div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="id2973057"></a>Mask</h5>
                  </div>
                </div>
              </div>
              <p>
						Similarly, it is not useful to analyse masked points
						(for example, gridded points situated on land when use analyse oceanic data).
						The F90 subroutine <code class="varname"><a href="#sl_pca" title="3.2.1.&#xA0;: sl_pca">sl_pca</a></code>
						makes the supposition that none of the masked (all channels are analysed).
						However, as well as for the weights, it is possible to associate
						an spatial mask to a dataset in order to remove masked points when
						using the python module.
						Then, <code class="varname"><a href="#spanlib.pack" title="4.2.3.&#xA0; Pack a dataset and its weights according to its mask: spanlib.pack">spanlib.pack</a></code>
						can be used to "pack" (compress) data before they are analysed.
					</p>
            </div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="id2973093"></a>Analysing several variables at the same time</h5>
                  </div>
                </div>
              </div>
              <p>
						One can be interested in analysing several variables ate the same time.
						These variables may come from different regions, datasets and may be
						even of completely different nature.
						The essential problem of units may be solved using simple
						normalisations.
						Python function <code class="varname"><a href="#spanlib.stackData" title="4.2.1.&#xA0; Takes several data files, of same time and stacks them up together: spanlib.stackData">spanlib.stackData</a></code>
						can be used to "pack" (compress) data before they are analysed.
						Then, using <code class="varname"><a href="#spanlib.unStackData" title="4.2.2.&#xA0; Unstack data in the form returned from stackData: spanlib.unStackData">spanlib.unStackData</a></code>
						you can unpack results from you analysis.
						<a href="#raynal06">Raynaud et al (2006)</a> presents an example of use where variables
						such as sea surface temperature, wind stress modulus and air-sea CO2
						fluxes are analysed at the same time:
						the simultaneous variability of the variables is filtered and
						the dominant oscillations are extracted for each of these variables.
					</p>
            </div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="id2973141"></a>Reconstructions</h5>
                  </div>
                </div>
              </div>
              <p>
						Reconstructions (F90:<code class="varname"><a href="#sl_pca_rec" title="3.2.3.&#xA0;Reconstruction of a set of PCA components: sl_pca_rec">sl_pca_rec</a></code>,
						Python:<code class="varname"><a href="#&lt;SpAn_object&gt;.reconstruct" title="4.2.9.&#xA0; Reconstruct results from mssa or pca: &lt;SpAn_object&gt;.reconstruct">&lt;SpAn_object&gt;.reconstruct</a></code>)
						may not be necessary the multiplication of an EOF by its associated PC.
						When PCA is used for a reduction of d-o-f (see <a href="#pg:dof">Section 1.2, “Fundamentals”</a>),
						orginal PCs are first filtered and then converted back to the original space
						using saved EOFs.
					</p>
            </div>
          </div>
          <div class="sect3" lang="en" xml:lang="en">
            <div class="titlepage">
              <div>
                <div>
                  <h4 class="title"><a id="doc_pre_tec_msa"></a>1.3.2. ...about MSSA</h4>
                </div>
              </div>
            </div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="window"></a>The window parameter</h5>
                  </div>
                </div>
              </div>
              <p>
						This is the only and essential parameter of SSA and MSSA
						(F90:<code class="varname"><a href="#sl_pca_rec" title="3.2.3.&#xA0;Reconstruction of a set of PCA components: sl_pca_rec">sl_mssa</a></code>,
						Python:<code class="varname"><a href="#&lt;SpAn_object&gt;.mssa" title="4.2.7.&#xA0; MultiChannel Singular Spectrum Analysis (MSSA): &lt;SpAn_object&gt;.mssa">&lt;SpAn_object&gt;.mssa</a></code>).
						It defines the maximal value of the lags use when building
						the covariance matrix.
						It acts as a spectral parameter: the spectral resolution
						is higher for periods lower than this period.
						A standard value is one third of the time dimension.
					</p>
            </div>
            <div class="simplesect" lang="en" xml:lang="en"><div class="titlepage"><div><div><h5 class="title"><a id="prepcamssa"></a>Pre-PCA</h5></div></div></div>
					Since the covariance matrix may quickly huge depending on
					parameters (number of channels and window size), is more appropriate
					to perform a pre-PCA to reduce the number of channels.
				</div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="id2973241"></a>Phase composites</h5>
                  </div>
                </div>
              </div>
              <p>
						One of the most important interests of MSSA is to be able to
						extract intermittent space-time oscillations from the signal.
						At the first order, an oscillation is its "typical" cycle.
						<code class="varname"><a href="#sl_phasecomp" title="3.2.7.&#xA0;Phase composites: sl_phasecomp">sl_phasecomp</a></code> (F90)
						and
						<code class="varname"><a href="#spanlib.computePhases" title="4.2.4.&#xA0; Phase composites for oscillatory fields: spanlib.computePhases">spanlib.computePhases</a></code> (Python)
						perfom phases composites: it computes an averaged cycle and cut it an
						homegeneous parts (as one can do for the annual cycle in 12 months).
					</p>
            </div>
          </div>
          <div class="sect3" lang="en" xml:lang="en">
            <div class="titlepage">
              <div>
                <div>
                  <h4 class="title"><a id="doc_pre_tec_svd"></a>1.3.3. ...about SVD</h4>
                </div>
              </div>
            </div>
            <div class="simplesect" lang="en" xml:lang="en"><div class="titlepage"><div><div><h5 class="title"><a id="prepcasvd"></a>Pre-PCA</h5></div></div></div>
					Unlike PCA, is not possible to switch channel and time
					dimension to computes EOFs.
					Therefore, it is common to perform a pre-PCA, like with
					MSSA, to reduce the number of channels.
				</div>
          </div>
        </div>
        <div class="sect2" lang="en" xml:lang="en">
          <div class="titlepage">
            <div>
              <div>
                <h3 class="title"><a id="doc_pre_mor"></a>1.4. For more information</h3>
              </div>
            </div>
          </div>
          <p>
				For more information about PCA, MSSA and SVD may be found in papers and on the web.
				See for example:
				</p>
          <div class="itemizedlist">
            <ul type="disc">
              <li><span class="bold"><a id="pca"></a><strong>PCA: </strong></span><a href="#prei88">Preisendorfer (1988)</a>,
						<a href="#wilk95">Wilks (1995)</a>.
					</li>
              <li><span class="bold"><a id="ssa"></a><strong>SSA: </strong></span><a href="#brki86">Broomhead and King (1986)</a>,
						<a href="#vagh89">Vautard and Ghil (1989)</a>.
					</li>
              <li><span class="bold"><a id="mssa"></a><strong>MSSA: </strong></span><a href="#plva94">Plaut and Vautard (1994)</a>,
						<a href="#raynal05">Raynaud et al (2005)</a>,
						<a href="#raynal06">Raynaud et al (2006)</a>.
					</li>
              <li><span class="bold"><a id="svd"></a><strong>SVD: </strong></span>,
					</li>
            </ul>
          </div>
          <p>
				You can also browse <a href="#doc_lin" title="5.&#xA0;Links">Section 5, “Links”</a>.
			</p>
        </div>
        <div class="sect2" lang="en" xml:lang="en">
          <div class="titlepage">
            <div>
              <div>
                <h3 class="title"><a id="doc_int_vie"></a>1.5. View colorized sources</h3>
              </div>
            </div>
          </div>
          <p>
				An html version of the source codes is available here:
				</p>
          <div class="itemizedlist">
            <ul type="disc">
              <li><code class="filename"><a href="src_f90_lib.html" target="_top">spanlib.f90</a></code>
						for the <a href="#doc_f90" title="3.&#xA0;The Fortran 90 library">fortran library</a>,
					</li>
              <li><code class="filename"><a href="src_pyt_mod.html" target="_top">spanlib_python.py</a></code>
						for the <a href="#doc_pyt" title="4.&#xA0;The python module">python module</a>.
					</li>
            </ul>
          </div>
          <p>
				Syntax is highlighted for both fortran and python codes.
			</p>
        </div>
      </div>
      <div class="sect1" lang="en" xml:lang="en">
        <div class="titlepage">
          <div>
            <div>
              <h2 class="title" style="clear: both"><a id="doc_ins"></a>2. Installation</h2>
            </div>
          </div>
        </div>
        <div class="sect2" lang="en" xml:lang="en">
          <div class="titlepage">
            <div>
              <div>
                <h3 class="title"><a id="doc_ins_req"></a>2.1. Requirements</h3>
              </div>
            </div>
          </div>
          <div class="sect3" lang="en" xml:lang="en">
            <div class="titlepage">
              <div>
                <div>
                  <h4 class="title"><a id="id3019521"></a>2.1.1. Fortran library</h4>
                </div>
              </div>
            </div>
            <p>
					You need a F90 compiler to compile it, and <a href="http://www.netlib.org/lapack/" target="_top">BLAS/LAPACK/LAPACK95</a>
					libraries compilated using this F90 compiler to be able to link with library.
				</p>
            <p>To run the F90 examples, you also need the F90 netcdf library.</p>
          </div>
          <div class="sect3" lang="en" xml:lang="en">
            <div class="titlepage">
              <div>
                <div>
                  <h4 class="title"><a id="id3019543"></a>2.1.2. Python module</h4>
                </div>
              </div>
            </div>
            <p>You need the fortran library, and the pyfort and Numeric modules from <a href="http://www-pcmdi.llnl.gov/software-portal/cdat" target="_top">CDAT</a>.</p>
            <p>To run python example, you needs the <code class="literal">cdms</code> and <code class="literal">vcs</code> modules (delivered with <a href="http://www-pcmdi.llnl.gov/software-portal/cdat" target="_top">CDAT</a>).</p>
          </div>
        </div>
        <div class="sect2" lang="en" xml:lang="en">
          <div class="titlepage">
            <div>
              <div>
                <h3 class="title"><a id="doc_ins_dow"></a>2.2. Download</h3>
              </div>
            </div>
          </div>
          <p>
				You can download the sources (tarball) of the package from the <a href="http://sourceforge.net/project/showfiles.php?group_id=168272" target="_top">Sourceforge repositories</a> of the project.
				Then, just type for example:

</p>
          <pre class="programlisting">
<code class="prompt">&lt;user&gt;</code> <strong class="userinput"><code>tar xzf spanlib-1.2.tgz</code></strong>
<code class="prompt">&lt;user&gt;</code> <strong class="userinput"><code>cd spanlib-1.2</code></strong>
</pre>
          <p>.

			</p>
        </div>
        <div class="sect2" lang="en" xml:lang="en">
          <div class="titlepage">
            <div>
              <div>
                <h3 class="title"><a id="doc_ins_ins"></a>2.3. Compilation and installation</h3>
              </div>
            </div>
          </div>
          <p>Detailed instructions can be found in the INSTALL file of the package.</p>
          <div class="procedure">
            <ol type="1">
              <li>
                <p>
						First, compile it with:

</p>
                <pre class="programlisting">
<code class="prompt">&lt;user&gt;</code> <strong class="userinput"><code>./configure</code></strong>
<code class="prompt">&lt;user&gt;</code> <strong class="userinput"><code>make</code></strong>
</pre>
                <p>
					</p>
              </li>
              <li>
                <p>
						Second, install it as root:
</p>
                <pre class="programlisting">
<code class="prompt">&lt;user&gt;</code> <strong class="userinput"><code>su</code></strong>
<code class="prompt">&lt;root&gt;</code> <strong class="userinput"><code>make install</code></strong>
</pre>
                <p>.

					</p>
              </li>
            </ol>
          </div>
          <p>
				Here is an example of <strong class="userinput"><code>./configure</code></strong>:
				</p>
          <pre class="programlisting"><code class="prompt">&lt;user&gt;</code> <strong class="userinput"><code>./configure --with-blas-lib=/usr/local/install/lapack-3.0/lib \
--with-netcdf-lib=/usr/local/install/netcdf-3.6.1/lib \
--with-netcdf-inc=/usr/local/install/netcdf-3.6.1/include \
--prefix=$HOME --with-pythondir=$HOME/python FC=ifort</code></strong></pre>
          <p>
			</p>
          <p>
				You can list all <span><strong class="command">configure</strong></span> options using:
				</p>
          <pre class="programlisting"><code class="prompt">&lt;user&gt;</code> <strong class="userinput"><code>./configure --help</code></strong></pre>
          <p>
				You can also list usefull <span><strong class="command">make</strong></span> targets with:
				</p>
          <pre class="programlisting"><code class="prompt">&lt;user&gt;</code> <strong class="userinput"><code>.make  help</code></strong></pre>
          <p>
			</p>
        </div>
      </div>
      <div class="sect1" lang="en" xml:lang="en">
        <div class="titlepage">
          <div>
            <div>
              <h2 class="title" style="clear: both"><a id="doc_f90"></a>3. The Fortran 90 library</h2>
            </div>
          </div>
        </div>
        <div class="sect2" lang="en" xml:lang="en">
          <div class="titlepage">
            <div>
              <div>
                <h3 class="title"><a id="doc_f90_int"></a>3.1. Introduction</h3>
              </div>
            </div>
          </div>
          <p>
				The fortran 90 library provides a list of subroutines to perform PCA, MSSA, recontructions and phase composites.
			</p>
          <div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3>
				The channel (spatial) dimension is always 1D.
				Therefore, as in the python module, multi-dimensional arrays must be
				packed before being analysed.
				You can use <code class="literal">pack</code> and <code class="literal">unpack</code> F90 subroutines
				for this task, and optionally give a mask to remove masked points.
				If you analyse several variables at the same time, concatenate
				normalised packed arrays before the analsysis.
			</div>
        </div>
        <div class="sect2" lang="en" xml:lang="en">
          <div class="titlepage">
            <div>
              <div>
                <h3 class="title"><a id="doc_f90_sub"></a>3.2. F90 subroutines</h3>
              </div>
            </div>
          </div>
          <div class="sect3" lang="en" xml:lang="en">
            <div class="titlepage">
              <div>
                <div>
                  <h4 class="title"><a id="sl_pca"></a>3.2.1. : <code class="literal">sl_pca</code></h4>
                </div>
              </div>
            </div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="id2971201"></a>Usage</h5>
                  </div>
                </div>
              </div>
              <pre class="programlisting">call <span class="HLpersonalised">sl_pca</span>(<span class="HLpersonalised">ff</span>, <span class="HLpersonalised">nkeep</span>, <span class="HLpersonalised">xeof</span>, <span class="HLpersonalised">pc</span>, <span class="HLpersonalised">ev</span>, <span class="HLpersonalised">ev_sum</span>, <span class="HLpersonalised">weights</span>, useteof=<span class="HLpersonalised">useteof</span>, <span class="HLpersonalised">bLargeMatrix</span>)</pre>
            </div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="id2995251"></a>Description</h5>
                  </div>
                </div>
              </div>
              <p>
Perform a decomposition of space-time field in a set of
Empirical Orthogonal Functions (EOFs) and Principal components (PCs).
The input data set can be optionally weighted in space.
By default, the analysis computes  "temporal" (T) or classical
spatial (S) EOFs depending on if the space dimension is greater
than the time dimension. This default behavior can be overridden.
		</p>
            </div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="id2995268"></a>Necessary arguments</h5>
                  </div>
                </div>
              </div>
              <div class="itemizedlist">
                <ul type="disc">
                  <li><code class="varname">ff    </code><code class="option"><span class="ARGspec">    </span></code> 
				 :: <span class="emphasis"><em>			Space-time array</em></span></li>
                  <li><code class="varname">nkeep    </code><code class="option"><span class="ARGspec">[intent:input, type:integer]    </span></code> 
				 :: <span class="emphasis"><em>		Maximum number of modes to keep in outputs</em></span></li>
                  <li><code class="varname">xeof    </code><code class="option"><span class="ARGspec">    </span></code> 
				 :: <span class="emphasis"><em>		Space-mode array of EOFs</em></span></li>
                  <li><code class="varname">pc    </code><code class="option"><span class="ARGspec">    </span></code> 
				 :: <span class="emphasis"><em>			Time-mode array of PCs</em></span></li>
                  <li><code class="varname">ev    </code><code class="option"><span class="ARGspec">    </span></code> 
				 :: <span class="emphasis"><em>			Mode array of eigen values (variances)</em></span></li>
                  <li><code class="varname">ev_sum    </code><code class="option"><span class="ARGspec">    </span></code> 
				 :: <span class="emphasis"><em></em></span></li>
                  <li><code class="varname">weights    </code><code class="option"><span class="ARGspec">    </span></code> 
				 :: <span class="emphasis"><em>	Space array of weights</em></span></li>
                </ul>
              </div>
            </div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="id2971321"></a>Optional arguments</h5>
                  </div>
                </div>
              </div>
              <div class="itemizedlist">
                <ul type="disc">
                  <li><code class="varname">useteof    </code><code class="option"><span class="ARGspec">[intent:input, type:integer]    </span></code> 
				 :: <span class="emphasis"><em>	To force the use of T or S EOFs [0 = T, 1 = S, -1 = default]</em></span></li>
                </ul>
              </div>
            </div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="id2971352"></a>Necessary arguments</h5>
                  </div>
                </div>
              </div>
              <div class="itemizedlist">
                <ul type="disc">
                  <li><code class="varname">bLargeMatrix    </code><code class="option"><span class="ARGspec">    </span></code> 
				 :: <span class="emphasis"><em> Use la_syevd instead of la_syev (faster for large </em></span></li>
                </ul>
              </div>
            </div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="id2971385"></a>Dependencies</h5>
                  </div>
                </div>
              </div>
              <p>
<code class="literal">[sd]gemm(BLAS) [sd]syrk(BLAS) la_syev(LAPACK95) la_syevd(LAPACK95)</code>
		</p>
            </div>
          </div>
          <div class="sect3" lang="en" xml:lang="en">
            <div class="titlepage">
              <div>
                <div>
                  <h4 class="title"><a id="sl_pca_getec"></a>3.2.2. Compute PCA expansion coefficients
Get an expansion coefficients from a space-time field
and a set of EOFs computed by PCA. If the input
space-time field is the same as the one used to computes
input ST-EOFs, these expansion coincide with the: <code class="literal">sl_pca_getec</code></h4>
                </div>
              </div>
            </div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="id2971417"></a>Usage</h5>
                  </div>
                </div>
              </div>
              <pre class="programlisting">call <span class="HLpersonalised">sl_pca_getec</span>(<span class="HLpersonalised">ff</span>, <span class="HLpersonalised">xeof</span>, <span class="HLpersonalised">ec</span>, <span class="HLpersonalised">weights</span>)</pre>
            </div>
          </div>
          <div class="sect3" lang="en" xml:lang="en">
            <div class="titlepage">
              <div>
                <div>
                  <h4 class="title"><a id="sl_pca_rec"></a>3.2.3. Reconstruction of a set of PCA components: <code class="literal">sl_pca_rec</code></h4>
                </div>
              </div>
            </div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="id2971471"></a>Usage</h5>
                  </div>
                </div>
              </div>
              <pre class="programlisting">call <span class="HLpersonalised">sl_pca_rec</span>(<span class="HLpersonalised">xeof</span>, <span class="HLpersonalised">pc</span>, <span class="HLpersonalised">ffrec</span>, istart=<span class="HLpersonalised">istart</span>, iend=<span class="HLpersonalised">iend</span>)</pre>
            </div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="id2971519"></a>Description</h5>
                  </div>
                </div>
              </div>
              <p>
Perform a reconstruction using a set of components previously
computed with a PCA. All the reconstructed components are summed.
A reconstructed component is simply the "product" of an EOF
by its PC. The sum of all reconstructed component is the original field.
		</p>
            </div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="id2971534"></a>Necessary arguments</h5>
                  </div>
                </div>
              </div>
              <div class="itemizedlist">
                <ul type="disc">
                  <li><code class="varname">xeof    </code><code class="option"><span class="ARGspec">    </span></code> 
				 :: <span class="emphasis"><em>		Space-mode array of EOFs</em></span></li>
                  <li><code class="varname">pc    </code><code class="option"><span class="ARGspec">    </span></code> 
				 :: <span class="emphasis"><em>		Time-mode array of PCs</em></span></li>
                  <li><code class="varname">ffrec    </code><code class="option"><span class="ARGspec">    </span></code> 
				 :: <span class="emphasis"><em>	Space-time array of the reconstructed field</em></span></li>
                </ul>
              </div>
            </div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="id2971608"></a>Optional arguments</h5>
                  </div>
                </div>
              </div>
              <div class="itemizedlist">
                <ul type="disc">
                  <li><code class="varname">istart    </code><code class="option"><span class="ARGspec">[intent:input, type:integer]    </span></code> 
				 :: <span class="emphasis"><em>	Index of the first component to use</em></span></li>
                  <li><code class="varname">iend    </code><code class="option"><span class="ARGspec">[intent:input, type:integer]    </span></code> 
				 :: <span class="emphasis"><em>		Index of the last component to use</em></span></li>
                </ul>
              </div>
            </div>
          </div>
          <div class="sect3" lang="en" xml:lang="en">
            <div class="titlepage">
              <div>
                <div>
                  <h4 class="title"><a id="sl_mssa"></a>3.2.4. Multi-channel Singular Spectrum Analysis: <code class="literal">sl_mssa</code></h4>
                </div>
              </div>
            </div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="id3021734"></a>Usage</h5>
                  </div>
                </div>
              </div>
              <pre class="programlisting">call <span class="HLpersonalised">sl_mssa</span>(<span class="HLpersonalised">ff</span>, <span class="HLpersonalised">nwindow</span>, <span class="HLpersonalised">nkeep</span>, <span class="HLpersonalised">steof</span>, <span class="HLpersonalised">stpc</span>, <span class="HLpersonalised">ev</span>, <span class="HLpersonalised">ev_sum</span>, <span class="HLpersonalised">bLargeMatrix</span>)</pre>
            </div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="id3021790"></a>Description</h5>
                  </div>
                </div>
              </div>
              <p>
Perform a decomposition of space-time field in a set of
space-time Empirical Orthogonal Functions (EOFs) and
time Principal components (PCs), according to a window
parameter.
		</p>
            </div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="id3021803"></a>Necessary arguments</h5>
                  </div>
                </div>
              </div>
              <div class="itemizedlist">
                <ul type="disc">
                  <li><code class="varname">ff    </code><code class="option"><span class="ARGspec">    </span></code> 
				 :: <span class="emphasis"><em>      Space-time array</em></span></li>
                  <li><code class="varname">nwindow    </code><code class="option"><span class="ARGspec">[intent:input, type:integer]    </span></code> 
				 :: <span class="emphasis"><em> Window size</em></span></li>
                  <li><code class="varname">nkeep    </code><code class="option"><span class="ARGspec">[intent:input, type:integer]    </span></code> 
				 :: <span class="emphasis"><em>   Maximum number of modes to keep in outputs</em></span></li>
                  <li><code class="varname">steof    </code><code class="option"><span class="ARGspec">    </span></code> 
				 :: <span class="emphasis"><em>  Space-window-mode array of EOFs</em></span></li>
                  <li><code class="varname">stpc    </code><code class="option"><span class="ARGspec">    </span></code> 
				 :: <span class="emphasis"><em>   Time-mode array of PCs</em></span></li>
                  <li><code class="varname">ev    </code><code class="option"><span class="ARGspec">    </span></code> 
				 :: <span class="emphasis"><em>     Mode array of eigen values (variances)</em></span></li>
                  <li><code class="varname">ev_sum    </code><code class="option"><span class="ARGspec">    </span></code> 
				 :: <span class="emphasis"><em></em></span></li>
                  <li><code class="varname">bLargeMatrix    </code><code class="option"><span class="ARGspec">    </span></code> 
				 :: <span class="emphasis"><em> Use ssyevd instead of ssyev (faster for large matrices, </em></span></li>
                </ul>
              </div>
            </div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="id3021959"></a>Dependencies</h5>
                  </div>
                </div>
              </div>
              <p>
<code class="literal">la_syev(LAPACK95) la_syevd(LAPACK95)</code>
		</p>
            </div>
          </div>
          <div class="sect3" lang="en" xml:lang="en">
            <div class="titlepage">
              <div>
                <div>
                  <h4 class="title"><a id="sl_mssa_getec"></a>3.2.5. Computes MSSA expansion coefficients
Get an expansion coefficients from a space-time field
and a set of ST-EOFs computed by MSSA. If the input
space-time field is the same as the one used to computes
input ST-EOFs, these expansion coincide with the: <code class="literal">sl_mssa_getec</code></h4>
                </div>
              </div>
            </div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="id3021988"></a>Usage</h5>
                  </div>
                </div>
              </div>
              <pre class="programlisting">call <span class="HLpersonalised">sl_mssa_getec</span>(<span class="HLpersonalised">ff</span>, <span class="HLpersonalised">steof</span>, <span class="HLpersonalised">nwindow</span>, <span class="HLpersonalised">stec</span>)</pre>
            </div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="id3022023"></a>Dependencies</h5>
                  </div>
                </div>
              </div>
              <p>
<code class="literal">[sd]gemm(BLAS)</code>
		</p>
            </div>
          </div>
          <div class="sect3" lang="en" xml:lang="en">
            <div class="titlepage">
              <div>
                <div>
                  <h4 class="title"><a id="sl_mssa_rec"></a>3.2.6. Reconstruction of a set of MSSA components: <code class="literal">sl_mssa_rec</code></h4>
                </div>
              </div>
            </div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="id3022048"></a>Usage</h5>
                  </div>
                </div>
              </div>
              <pre class="programlisting">call <span class="HLpersonalised">sl_mssa_rec</span>(<span class="HLpersonalised">steof</span>, <span class="HLpersonalised">stpc</span>, <span class="HLpersonalised">nwindow</span>, <span class="HLpersonalised">ffrec</span>, istart=<span class="HLpersonalised">istart</span>, iend=<span class="HLpersonalised">iend</span>)</pre>
            </div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="id3022094"></a>Description</h5>
                  </div>
                </div>
              </div>
              <p>
Same as for the reconstruction of PCA components, but for MSSA.
		</p>
            </div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="id3022104"></a>Necessary arguments</h5>
                  </div>
                </div>
              </div>
              <div class="itemizedlist">
                <ul type="disc">
                  <li><code class="varname">steof    </code><code class="option"><span class="ARGspec">    </span></code> 
				 :: <span class="emphasis"><em>   SpaceXwindow-mode array of EOFs</em></span></li>
                  <li><code class="varname">stpc    </code><code class="option"><span class="ARGspec">    </span></code> 
				 :: <span class="emphasis"><em>    Time-mode array of PCs</em></span></li>
                  <li><code class="varname">nwindow    </code><code class="option"><span class="ARGspec">[intent:input, type:integer]    </span></code> 
				 :: <span class="emphasis"><em> Window size</em></span></li>
                  <li><code class="varname">ffrec    </code><code class="option"><span class="ARGspec">    </span></code> 
				 :: <span class="emphasis"><em>   Space-time array of the reconstructed field</em></span></li>
                </ul>
              </div>
            </div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="id3022188"></a>Optional arguments</h5>
                  </div>
                </div>
              </div>
              <div class="itemizedlist">
                <ul type="disc">
                  <li><code class="varname">istart    </code><code class="option"><span class="ARGspec">[intent:input, type:integer]    </span></code> 
				 :: <span class="emphasis"><em> Index of the first component to use</em></span></li>
                  <li><code class="varname">iend    </code><code class="option"><span class="ARGspec">[intent:input, type:integer]    </span></code> 
				 :: <span class="emphasis"><em>   Index of the last component to use</em></span></li>
                </ul>
              </div>
            </div>
          </div>
          <div class="sect3" lang="en" xml:lang="en">
            <div class="titlepage">
              <div>
                <div>
                  <h4 class="title"><a id="sl_phasecomp"></a>3.2.7. Phase composites: <code class="literal">sl_phasecomp</code></h4>
                </div>
              </div>
            </div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="id3022247"></a>Usage</h5>
                  </div>
                </div>
              </div>
              <pre class="programlisting">call <span class="HLpersonalised">sl_phasecomp</span>(<span class="HLpersonalised">ffrec</span>, <span class="HLpersonalised">np</span>, <span class="HLpersonalised">phases</span>, <span class="HLpersonalised">weights</span>, <span class="HLpersonalised">offset</span>, <span class="HLpersonalised">firstphase</span>)</pre>
            </div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="id3022293"></a>Description</h5>
                  </div>
                </div>
              </div>
              <p>
Performs phase composites of S-T oscillatory field.
This field is typically a reconstructed pair of MSSA modes.
Composites are evaluated according to an index defined by the
first PC of the input field and its derivative.
Space weights can be optionally used to compute the PC.
A minimal normalized amplitude can be also used: when the
index is under value, data are not used to compute phases.
It is also possible so specify the angle of the first phase
in the 360 degrees phase diagram circle: zero means the
the first phase conincides with the maximmum.
		</p>
            </div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="id3022312"></a>Necessary arguments</h5>
                  </div>
                </div>
              </div>
              <div class="itemizedlist">
                <ul type="disc">
                  <li><code class="varname">ffrec    </code><code class="option"><span class="ARGspec">    </span></code> 
				 :: <span class="emphasis"><em> Space-time array</em></span></li>
                  <li><code class="varname">np    </code><code class="option"><span class="ARGspec">[intent:input, type:integerdefault:<span class="HLpersonalised">8</span>]    </span></code> 
				 :: <span class="emphasis"><em>    Number of requested phases over the 360 degrees cycle </em></span></li>
                  <li><code class="varname">phases    </code><code class="option"><span class="ARGspec">    </span></code> 
				 :: <span class="emphasis"><em></em></span></li>
                  <li><code class="varname">weights    </code><code class="option"><span class="ARGspec">    </span></code> 
				 :: <span class="emphasis"><em>    Space array of weights</em></span></li>
                  <li><code class="varname">offset    </code><code class="option"><span class="ARGspec">    </span></code> 
				 :: <span class="emphasis"><em>     Minimal normalized amplitude of the index </em></span></li>
                  <li><code class="varname">firstphase    </code><code class="option"><span class="ARGspec">    </span></code> 
				 :: <span class="emphasis"><em> Value in degrees of the first phase </em></span></li>
                </ul>
              </div>
            </div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="id3022436"></a>Dependencies</h5>
                  </div>
                </div>
              </div>
              <p>
			<span class="HLpersonalised"><code class="literal"><a href="#sl_pca" title="3.2.1.&#xA0;: sl_pca">sl_pca</a></code></span>
		</p>
            </div>
          </div>
        </div>
        <div class="sect2" lang="en" xml:lang="en">
          <div class="titlepage">
            <div>
              <div>
                <h3 class="title"><a id="doc_f90_exa"></a>3.3. Fortran 90 examples</h3>
              </div>
            </div>
          </div>
          <p>
				Theses examples illustrate of how to use the Fortran 90 component of Spanlib.
				Sea surface Temperature anomalies from a netcdf format
				is the dataset analysed in both examples.
				</p>
          <div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3>
					Each example create an output netcdf file.
					The configure script should have tried to find a way
					to view these outputs (like <span><strong class="command">ncview</strong></span>,
					<span><strong class="command">vcdat</strong></span>, or a simple python script provided
					with the package).
					If it failed, you will have to visualise results by yourself
					(indications are provided and the end of the run).
				</div>
          <p>
			</p>
          <div class="sect3" lang="en" xml:lang="en">
            <div class="titlepage">
              <div>
                <div>
                  <h4 class="title"><a id="doc_f90_ex1"></a>3.3.1. F90 example 1</h4>
                </div>
              </div>
            </div>
            <p>
					In this example, PCA is performed on the whole dataset to reduce
					the number of channels. These channels are then given
					as input to the MSSA, from which the eigenvalues and the
					dominant oscillatory mode of the El Nino variability are extracted
					and stored to the output netcdf file.
					Phase composites are also computed to represent the oscillation over its cycle.
				</p>
            <div class="example">
              <a id="id3019942"></a>
              <p class="title">
                <b>Example 1. F90 example 1</b>
              </p>
              <p>
						You can run this example typing (from package directory):
						</p>
              <pre class="programlisting"><code class="prompt">&lt;user&gt;</code> <strong class="userinput"><code>make example</code></strong></pre>
              <p> or
						</p>
              <pre class="programlisting"><code class="prompt">&lt;user&gt;</code> <strong class="userinput"><code>make fortran1</code></strong></pre>
              <p>
						This command will first try to download the dataset,
						then compile the following f90 program, run it,
						and finally try to visualise output data.
						See <a href="#doc_ins_req" title="2.1.&#xA0;Requirements">Section 2.1, “Requirements”</a> if it fails.
					</p>
              <p>
						The source code of this example is highlighted below, with comments inside.
						</p>
              <pre class="programlisting"><span class="HLcomments">! File: example1.f90</span>
<span class="HLcomments">!</span>
<span class="HLcomments">! This file is part of the SpanLib library.</span>
<span class="HLcomments">! Copyright (C) 2006  Stephane Raynaud</span>
<span class="HLcomments">! Contact: stephane dot raynaud at gmail dot com</span>
<span class="HLcomments">!</span>
<span class="HLcomments">! This library is free software; you can redistribute it and/or</span>
<span class="HLcomments">! modify it under the terms of the GNU Lesser General Public</span>
<span class="HLcomments">! License as published by the Free Software Foundation; either</span>
<span class="HLcomments">! version 2.1 of the License, or (at your option) any later version.</span>
<span class="HLcomments">!</span>
<span class="HLcomments">! This library is distributed in the hope that it will be useful,</span>
<span class="HLcomments">! but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="HLcomments">! MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="HLcomments">! Lesser General Public License for more details.</span>
<span class="HLcomments">!</span>
<span class="HLcomments">! You should have received a copy of the GNU Lesser General Public</span>
<span class="HLcomments">! License along with this library; if not, write to the Free Software</span>
<span class="HLcomments">! Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA</span>

<span class="HLroutines">program</span> example

	<span class="HLcomments">! This simple example shows how to PCA and MSSA subroutines from this package.</span>
	<span class="HLcomments">! Warning: it requires netcdf for in/outputs.</span>
	<span class="HLcomments">!</span>
	<span class="HLcomments">! We start from longitude/latitude/time value of Pacific Sea Surface Temperature</span>
	<span class="HLcomments">! that include the El Nino Southern Oscillation signal.</span>
	<span class="HLcomments">! Input is the netcdf file data2.cdf.</span>
	<span class="HLcomments">! We remove land points from the initial array according</span>
	<span class="HLcomments">! to the netcdf missing_value attribute of the analysed variable (data are "packed").</span>
	<span class="HLcomments">! A PCA is used to reduce the degrees of freedoom before MSSA analysis.</span>
	<span class="HLcomments">! Weights for PCA are computed as a fonction of latitude.</span>
	<span class="HLcomments">! Then, we assume that we have already identified an oscillation (after tests).</span>
	<span class="HLcomments">! This oscillation, given by a pair of MSSA modes, is then</span>
	<span class="HLcomments">! reconstructed from the MSSA and PCA spaces.</span>
	<span class="HLcomments">! Finally, phase composites are computed from this reconstructed oscillation.</span>
	<span class="HLcomments">! The oscillation is outputed in a netcdf file (pair_1.cdf).</span>
	<span class="HLcomments">! MSSA eigenvalue are stored in the output netcdf file. This shows</span>
	<span class="HLcomments">! you pairs due to oscillatory modes.</span>
	<span class="HLcomments">!</span>
	<span class="HLcomments">! Initial data set (data2.cdf):</span>
	<span class="HLcomments">! - origin: updated Reynolds and Smith (1996) SST (netcdf file)</span>
	<span class="HLcomments">! - origin url: data selector from http://iridl.ldeo.columbia.edu</span>
	<span class="HLcomments">! - how to get it [10Mb]: http://stefdeperou.free.fr/pub/data.cdf</span>
	<span class="HLcomments">! - area of study: tropical pacific [130.5E:75.5W, 29.5S:29.5N] (155x60 grid points)</span>
	<span class="HLcomments">! - period of study: Jan1982:Dec2005 (288 time steps)</span>
	<span class="HLcomments">!</span>
	<span class="HLcomments">! Parameters:</span>
	<span class="HLcomments">! - Only the first 20 PCs are retainedand given to the MSSA</span>
	<span class="HLcomments">! - A window of 7 years (84 months) is chosen for the MSSA</span>
	<span class="HLcomments">! - Phase composites use 8 phases</span>
	<span class="HLcomments">! - An offset of 0.4 and is used for composites</span>
	<span class="HLcomments">! - The first phase of composites is set at 180 degrees (minimal value)</span>
	<span class="HLcomments">!</span>
	<span class="HLcomments">! Note:</span>
	<span class="HLcomments">!	This example should run only a few seconds.</span>
	<span class="HLcomments">!	If it is not the case, your BLAS/LAPACK librairy is not optimized.</span>

	<span class="HLroutines">use</span> spanlib
	<span class="HLroutines">use</span> netcdf

	<span class="HLroutines">implicit</span> <span class="HLattributes">none</span>

	<span class="HLcomments">! Parameters</span>
	<span class="HLcomments">! ----------</span>
	<span class="HLroutines">integer</span>,<span class="HLattributes">parameter</span> :: nkeep_pca=<span class="HLdigits">10</span>, nkeep_mssa=<span class="HLdigits">6</span>, nwindow=<span class="HLdigits">84</span>, &amp;
		&amp; first_mode=<span class="HLdigits">1</span>, nphases=<span class="HLdigits">8</span>
	<span class="HLroutines">real</span>(wp), <span class="HLattributes">parameter</span> :: offset=<span class="HLdigits">0</span>.d0, first_phase=<span class="HLdigits">180</span>.d0, &amp;
		&amp; new_missing_value=-<span class="HLdigits">999</span>.d0
	<span class="HLroutines">character</span>(len=<span class="HLdigits">20</span>), <span class="HLattributes">parameter</span> :: input_nc_file=<span class="HLstrings">"data2.cdf"</span>, &amp;
		&amp; output_nc_file=<span class="HLstrings">"output_fortran1.nc"</span>, var_name=<span class="HLstrings">'ssta'</span>

	<span class="HLcomments">! Other declarations</span>
	<span class="HLcomments">! ------------------</span>
	<span class="HLroutines">real</span>(wp), <span class="HLattributes">allocatable</span> :: field(:,:,:), weights(:,:), &amp;
		&amp; lat(:), lon(:), time(:)
	<span class="HLroutines">real</span>(wp), <span class="HLattributes">allocatable</span> :: reco(:,:,:), phasecomps(:,:,:)
	<span class="HLroutines">logical</span>, <span class="HLattributes">allocatable</span> :: mask(:,:)
	<span class="HLroutines">real</span>(wp), <span class="HLattributes">allocatable</span> :: packed_field(:,:), &amp;
		&amp; packed_weights(:), packed_phasecomps(:,:), stphasecomps(:,:)
	<span class="HLroutines">real</span>(wp), <span class="HLattributes">allocatable</span> :: eof(:,:), pc(:,:), &amp;
		&amp; stpair(:,:), pair(:,:)
	<span class="HLroutines">real</span>(wp), <span class="HLattributes">allocatable</span> :: steof(:,:),stpc(:,:),stev(:)
	<span class="HLroutines">character</span>(len=<span class="HLdigits">20</span>) :: lon_units, lat_units, var_units, &amp;
		&amp;	lon_name, lat_name, time_name, time_units
	<span class="HLroutines">integer</span> :: ncid, dimids(<span class="HLdigits">5</span>), varid, lonid, latid, phaseid, &amp;
		&amp; timeid, phcoid, recoid, origid, modeid, evid
	<span class="HLroutines">integer</span>(kind=<span class="HLdigits">4</span>) :: i, nspace, nlon, nlat, ntime
	<span class="HLroutines">real</span>(wp) :: pi, missing_value

	<span class="HLcomments">! Precision</span>
	<span class="HLcomments">! ---------</span>
	<span class="HLroutines">if</span>(wp==<span class="HLdigits">8</span>)<span class="HLroutines">then</span>
		<span class="HLroutines">print</span>*,<span class="HLstrings">'Using double precision'</span>
	<span class="HLroutines">else</span>
		<span class="HLroutines">print</span>*,<span class="HLstrings">'Using simple precision'</span>
	<span class="HLroutines">end</span> <span class="HLroutines">if</span>

	<span class="HLcomments">! Get the initial sst field from the netcdf file</span>
	<span class="HLcomments">! ----------------------------------------------</span>
	<span class="HLroutines">print</span>*,<span class="HLstrings">'Reading inputs...'</span>
	<span class="HLroutines">call</span> err(nf90_open(input_nc_file, nf90_nowrite, ncid))
	<span class="HLroutines">call</span> err(nf90_inq_varid(ncid, var_name, varid))
	<span class="HLroutines">call</span> err(nf90_inquire_variable(ncid, varid, dimids=dimids(<span class="HLdigits">1</span>:<span class="HLdigits">3</span>)))
	<span class="HLroutines">call</span> err(nf90_inquire_dimension(ncid, dimids(<span class="HLdigits">1</span>), &amp;
		&amp;	name=lon_name, len=nlon))
	<span class="HLroutines">call</span> err(nf90_inquire_dimension(ncid, dimids(<span class="HLdigits">2</span>), &amp;
		&amp;	name=lat_name, len=nlat))
	<span class="HLroutines">call</span> err(nf90_inquire_dimension(ncid, dimids(<span class="HLdigits">3</span>), &amp;
		&amp;	name=time_name, len=ntime))
	<span class="HLfunctions">allocate</span>(field(nlon,nlat,ntime))
	<span class="HLfunctions">allocate</span>(mask(nlon,nlat))
	<span class="HLfunctions">allocate</span>(weights(nlon,nlat))
	<span class="HLfunctions">allocate</span>(lon(nlon))
	<span class="HLfunctions">allocate</span>(lat(nlat))
	<span class="HLfunctions">allocate</span>(time(ntime))
	<span class="HLroutines">call</span> err(nf90_get_var(ncid, varid, field))
	<span class="HLroutines">call</span> err(nf90_get_att(ncid, varid, <span class="HLstrings">'missing_value'</span>, &amp;
		&amp; missing_value))
	<span class="HLroutines">call</span> err(nf90_get_att(ncid, varid, <span class="HLstrings">'units'</span>, var_units))
	<span class="HLroutines">call</span> err(nf90_inq_varid(ncid, lon_name, varid))
	<span class="HLroutines">call</span> err(nf90_get_var(ncid, varid, lon))
	<span class="HLroutines">call</span> err(nf90_get_att(ncid, varid, <span class="HLstrings">'units'</span>, lon_units))
	<span class="HLroutines">call</span> err(nf90_inq_varid(ncid, lat_name, varid))
	<span class="HLroutines">call</span> err(nf90_get_var(ncid, varid, lat))
	<span class="HLroutines">call</span> err(nf90_get_att(ncid, varid, <span class="HLstrings">'units'</span>, lat_units))
	<span class="HLroutines">call</span> err(nf90_inq_varid(ncid, time_name, varid))
	<span class="HLroutines">call</span> err(nf90_get_var(ncid, varid, time))
	<span class="HLroutines">call</span> err(nf90_get_att(ncid, varid, <span class="HLstrings">'units'</span>, time_units))
	<span class="HLroutines">call</span> err(nf90_close(ncid))


	<span class="HLcomments">! Format (pack) data to have only one space dimension</span>
	<span class="HLcomments">! ---------------------------------------------------</span>
	<span class="HLroutines">print</span>*,<span class="HLstrings">'Packing...'</span>

	<span class="HLcomments">! Compute weights proportional to grid point area</span>
	pi = cos(-<span class="HLdigits">1</span>.)
	<span class="HLroutines">do</span> i=<span class="HLdigits">1</span>,nlat
		weights(:,i) = cos(lat(i)*pi/<span class="HLdigits">180</span>.)
	<span class="HLroutines">end</span> <span class="HLroutines">do</span>

	<span class="HLcomments">! Now pack</span>
	mask = (field(:,:,<span class="HLdigits">1</span>) /= missing_value)
	<span class="HLfunctions">allocate</span>(packed_field(count(mask), ntime))
	<span class="HLroutines">do</span> i=<span class="HLdigits">1</span>, ntime
		packed_field(:,i) = <span class="HLfunctions">pack</span>(field(:,:,i), mask)
	<span class="HLroutines">end</span> <span class="HLroutines">do</span>
	nspace = count(mask)
	<span class="HLfunctions">allocate</span>(packed_weights(nspace))
	packed_weights = <span class="HLfunctions">pack</span>(weights, mask)


	<span class="HLcomments">! Perform a PCA to reduce the d.o.f</span>
	<span class="HLcomments">! ---------------------------------</span>
	<span class="HLroutines">print</span>*,<span class="HLstrings">'[<span class="HLpersonalised">sl_pca</span>] Pre-PCA...'</span>
	<span class="HLfunctions">allocate</span>(eof(nspace, nkeep_pca))
	<span class="HLfunctions">allocate</span>(pc(ntime,   nkeep_pca))
	<span class="HLroutines">call</span> <span class="HLpersonalised">sl_pca</span>(packed_field, nkeep_pca, xeof=eof, &amp;
		&amp;	pc=pc, weights=packed_weights)
	<span class="HLfunctions">deallocate</span>(packed_field)

	<span class="HLcomments">! We send results from PCA to MSSA</span>
	<span class="HLcomments">! --------------------------------</span>
	<span class="HLroutines">print</span>*,<span class="HLstrings">'[<span class="HLpersonalised">sl_mssa</span>] MSSA...'</span>
	<span class="HLfunctions">allocate</span>(steof(nkeep_pca*nwindow, nkeep_mssa))
	<span class="HLfunctions">allocate</span>(stpc(ntime-nwindow+<span class="HLdigits">1</span>,    nkeep_mssa))
	<span class="HLfunctions">allocate</span>(stev(                    nkeep_mssa))
	<span class="HLroutines">call</span> <span class="HLpersonalised">sl_mssa</span>(<span class="HLfunctions">transpose</span>(pc), nwindow, nkeep_mssa, &amp;
		&amp;	steof=steof, stpc=stpc, ev=stev)

	<span class="HLcomments">! We reconstruct modes [first_mode + first_mode+1] of MSSA</span>
	<span class="HLcomments">! --------------------------------------------------------</span>
	<span class="HLroutines">print</span>*,<span class="HLstrings">'[<span class="HLpersonalised">sl_mssa_rec</span>] MSSA reconstruction...'</span>
	<span class="HLfunctions">allocate</span>(stpair(nkeep_pca, ntime))
	<span class="HLroutines">call</span> <span class="HLpersonalised">sl_mssa_rec</span>(steof(:,first_mode:first_mode+<span class="HLdigits">1</span>), &amp;
		&amp; stpc(:,first_mode:first_mode+<span class="HLdigits">1</span>), nwindow, stpair)
	<span class="HLfunctions">deallocate</span>(steof, stpc)

	<span class="HLcomments">! We compute phases composites for the reconstructed oscillation</span>
	<span class="HLcomments">! ---------------------------------------------------------------</span>
	<span class="HLroutines">print</span>*,<span class="HLstrings">'[<span class="HLpersonalised">sl_phasecomp</span>] Phase composites...'</span>
	<span class="HLfunctions">allocate</span>(stphasecomps(nkeep_pca, nphases))
	<span class="HLroutines">call</span> <span class="HLpersonalised">sl_phasecomp</span>(stpair, nphases, stphasecomps, &amp;
		&amp;	offset=offset, firstphase=first_phase)

	<span class="HLcomments">! We go back to the physical space for</span>
	<span class="HLcomments">! the full oscillation AND its composites</span>
	<span class="HLcomments">! ---------------------------------------</span>
	<span class="HLroutines">print</span>*,<span class="HLstrings">'[<span class="HLpersonalised">sl_pca_rec</span>] Back to the physical space...'</span>
	<span class="HLfunctions">allocate</span>(pair(nspace, ntime))
	<span class="HLroutines">call</span> <span class="HLpersonalised">sl_pca_rec</span>(eof, <span class="HLfunctions">transpose</span>(stpair), pair)
	<span class="HLfunctions">allocate</span>(packed_phasecomps(nspace, nphases))
	<span class="HLroutines">call</span> <span class="HLpersonalised">sl_pca_rec</span>(eof, <span class="HLfunctions">transpose</span>(stphasecomps), packed_phasecomps)
	<span class="HLfunctions">deallocate</span>(stpair, eof, stphasecomps)

	<span class="HLcomments">! Unpacking</span>
	<span class="HLcomments">! ---------</span>
	<span class="HLroutines">print</span>*,<span class="HLstrings">'Unpacking...'</span>
	<span class="HLfunctions">allocate</span>(reco(nlon,nlat,ntime))
	<span class="HLroutines">do</span> i=<span class="HLdigits">1</span>, ntime
		reco(:,:,i) = <span class="HLfunctions">unpack</span>(pair(:,i), mask, new_missing_value)
		where(.<span class="HLfunctions">not</span>.mask)field(:,:,i) = new_missing_value
	<span class="HLroutines">end</span> <span class="HLroutines">do</span>
	<span class="HLfunctions">allocate</span>(phasecomps(nlon,nlat,nphases))
	<span class="HLroutines">do</span> i=<span class="HLdigits">1</span>, nphases
		phasecomps(:,:,i) = <span class="HLfunctions">unpack</span>(packed_phasecomps(:,i), mask, &amp;
		 &amp; new_missing_value)
	<span class="HLroutines">end</span> <span class="HLroutines">do</span>

	<span class="HLcomments">! Write out the phase composites of the first oscillation</span>
	<span class="HLcomments">! -------------------------------------------------------</span>
	<span class="HLroutines">print</span>*,<span class="HLstrings">'Writing out...'</span>
	<span class="HLcomments">! File</span>
	<span class="HLroutines">call</span> err(nf90_create(output_nc_file, nf90_write, ncid))
	<span class="HLcomments">! Dimensions</span>
	<span class="HLroutines">call</span> err(nf90_def_dim(ncid, <span class="HLstrings">'lon'</span>, nlon, dimids(<span class="HLdigits">1</span>)))
	<span class="HLroutines">call</span> err(nf90_def_dim(ncid, <span class="HLstrings">'lat'</span>, nlat, dimids(<span class="HLdigits">2</span>)))
	<span class="HLroutines">call</span> err(nf90_def_dim(ncid, <span class="HLstrings">'time'</span>, ntime, dimids(<span class="HLdigits">3</span>)))
	<span class="HLroutines">call</span> err(nf90_def_dim(ncid, <span class="HLstrings">'phase'</span>, nphases, dimids(<span class="HLdigits">4</span>)))
	<span class="HLroutines">call</span> err(nf90_def_dim(ncid, <span class="HLstrings">'mode'</span>, nkeep_mssa, dimids(<span class="HLdigits">5</span>)))
	<span class="HLcomments">! Variables</span>
	<span class="HLroutines">call</span> err(nf90_def_var(ncid, <span class="HLstrings">'lon'</span>, nf90_float, dimids(<span class="HLdigits">1</span>), lonid))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, lonid, <span class="HLstrings">'long_name'</span>, <span class="HLstrings">'Longitude'</span>))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, lonid, <span class="HLstrings">'units'</span>, lon_units))
	<span class="HLroutines">call</span> err(nf90_def_var(ncid, <span class="HLstrings">'lat'</span>, nf90_float, dimids(<span class="HLdigits">2</span>), latid))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, latid, <span class="HLstrings">'long_name'</span>, <span class="HLstrings">'Latitude'</span>))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, latid, <span class="HLstrings">'units'</span>, lat_units))
	<span class="HLroutines">call</span> err(nf90_def_var(ncid, <span class="HLstrings">'time'</span>, nf90_float, dimids(<span class="HLdigits">3</span>), &amp;
		&amp; timeid))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, timeid, <span class="HLstrings">'long_name'</span>, <span class="HLstrings">'Time'</span>))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, timeid, <span class="HLstrings">'units'</span>, time_units))
	<span class="HLroutines">call</span> err(nf90_def_var(ncid, <span class="HLstrings">'phase'</span>, nf90_float, dimids(<span class="HLdigits">4</span>), &amp;
		&amp; phaseid))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, phaseid, <span class="HLstrings">'long_name'</span>, <span class="HLstrings">'Phase'</span>))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, phaseid, <span class="HLstrings">'units'</span>, <span class="HLstrings">'level'</span>))
	<span class="HLroutines">call</span> err(nf90_def_var(ncid, <span class="HLstrings">'mode'</span>, nf90_float, dimids(<span class="HLdigits">5</span>), &amp;
		&amp; modeid))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, modeid, <span class="HLstrings">'long_name'</span>, <span class="HLstrings">'Mode'</span>))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, modeid, <span class="HLstrings">'units'</span>, <span class="HLstrings">'level'</span>))
	<span class="HLroutines">call</span> err(nf90_def_var(ncid, <span class="HLstrings">'orig'</span>, nf90_float, dimids(<span class="HLdigits">1</span>:<span class="HLdigits">3</span>), &amp;
	 &amp; origid))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, origid, <span class="HLstrings">'long_name'</span>, &amp;
		&amp; <span class="HLstrings">'SST anomaly / original field'</span>))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, origid, <span class="HLstrings">'units'</span>, var_units))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, origid, <span class="HLstrings">'missing_value'</span>, &amp;
		&amp; new_missing_value))
	<span class="HLroutines">call</span> err(nf90_def_var(ncid, <span class="HLstrings">'reco1'</span>, nf90_float, dimids(<span class="HLdigits">1</span>:<span class="HLdigits">3</span>), &amp;
		&amp; recoid))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, recoid, <span class="HLstrings">'long_name'</span>, &amp;
		&amp; <span class="HLstrings">'SST anomaly / reconstruction of first pair'</span>))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, recoid, <span class="HLstrings">'units'</span>, var_units))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, recoid, <span class="HLstrings">'missing_value'</span>, &amp;
		&amp; new_missing_value))
	<span class="HLroutines">call</span> err(nf90_def_var(ncid, <span class="HLstrings">'pair1'</span>, nf90_float, &amp;
		&amp; (/dimids(<span class="HLdigits">1</span>),dimids(<span class="HLdigits">2</span>),dimids(<span class="HLdigits">4</span>)/), phcoid))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, phcoid, <span class="HLstrings">'long_name'</span>, &amp;
		&amp;<span class="HLstrings">'SST anomaly / phase composite of first pair'</span>))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, phcoid, <span class="HLstrings">'units'</span>, var_units))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, phcoid, <span class="HLstrings">'missing_value'</span>, &amp;
		&amp; new_missing_value))
	<span class="HLroutines">call</span> err(nf90_def_var(ncid, <span class="HLstrings">'ev'</span>, nf90_float, dimids(<span class="HLdigits">5</span>), evid))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, evid, <span class="HLstrings">'long_name'</span>, &amp;
		&amp;<span class="HLstrings">'MSSA eigen values'</span>))
	<span class="HLcomments">! Values</span>
	<span class="HLroutines">call</span> err(nf90_enddef(ncid))
	<span class="HLroutines">call</span> err(nf90_put_var(ncid, lonid, lon))
	<span class="HLroutines">call</span> err(nf90_put_var(ncid, latid, lat))
	<span class="HLroutines">call</span> err(nf90_put_var(ncid, timeid, time))
	<span class="HLroutines">call</span> err(nf90_put_var(ncid, phaseid, float((/(i,i=<span class="HLdigits">1</span>,nphases)/))))
	<span class="HLroutines">call</span> err(nf90_put_var(ncid, modeid, &amp;
		&amp; float((/(i,i=<span class="HLdigits">1</span>,nkeep_mssa)/))))
	<span class="HLroutines">call</span> err(nf90_put_var(ncid, origid, field))
	<span class="HLroutines">call</span> err(nf90_put_var(ncid, recoid, reco))
	<span class="HLroutines">call</span> err(nf90_put_var(ncid, phcoid, phasecomps))
	<span class="HLroutines">call</span> err(nf90_put_var(ncid, evid, stev))
	<span class="HLroutines">call</span> err(nf90_close(ncid))

<span class="HLroutines">end</span> <span class="HLroutines">program</span> example

<span class="HLroutines">subroutine</span> err(jstatus)

	<span class="HLroutines">use</span> netcdf

	<span class="HLroutines">integer</span> :: jstatus

	<span class="HLroutines">if</span> (jstatus .ne. nf90_noerr) <span class="HLroutines">then</span>
		<span class="HLroutines">print</span> *, <span class="HLfunctions">trim</span>(nf90_strerror(jstatus))
		stop
	<span class="HLroutines">end</span> <span class="HLroutines">if</span>

<span class="HLroutines">end</span> <span class="HLroutines">subroutine</span> err

</pre>
              <p>
					</p>
            </div>
          </div>
          <div class="sect3" lang="en" xml:lang="en">
            <div class="titlepage">
              <div>
                <div>
                  <h4 class="title"><a id="doc_f90_ex2"></a>3.3.2. F90 example 2</h4>
                </div>
              </div>
            </div>
            <p>
					The goal is to provide an example to show how SVD works.
					Using the same dataset of the previous example, two regions
					are selected (one in the left of the basin, one the west).
					Here PCA is performed these two resulting datasets to reduce
					the number of channels (as in the previous example).
					Then a SVD is computed and the first EOFs, PCs
					and joint eigen values are stored to the netcdf file.
				</p>
            <div class="example">
              <a id="id3020023"></a>
              <p class="title">
                <b>Example 2. F90 example 2</b>
              </p>
              <p>
						You can run this example typing (from package directory):
						</p>
              <pre class="programlisting"><code class="prompt">&lt;user&gt;</code> <strong class="userinput"><code>make fortran2</code></strong></pre>
              <p>
					</p>
              <p>
						The source code of this example is highlighted below, with comments inside.
						</p>
              <pre class="programlisting"><span class="HLcomments">! File: example2.f90</span>
<span class="HLcomments">!</span>
<span class="HLcomments">! This file is part of the SpanLib library.</span>
<span class="HLcomments">! Copyright (C) 2006  Stephane Raynaud</span>
<span class="HLcomments">! Contact: stephane dot raynaud at gmail dot com</span>
<span class="HLcomments">!</span>
<span class="HLcomments">! This library is free software; you can redistribute it and/or</span>
<span class="HLcomments">! modify it under the terms of the GNU Lesser General Public</span>
<span class="HLcomments">! License as published by the Free Software Foundation; either</span>
<span class="HLcomments">! version 2.1 of the License, or (at your option) any later version.</span>
<span class="HLcomments">!</span>
<span class="HLcomments">! This library is distributed in the hope that it will be useful,</span>
<span class="HLcomments">! but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="HLcomments">! MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="HLcomments">! Lesser General Public License for more details.</span>
<span class="HLcomments">!</span>
<span class="HLcomments">! You should have received a copy of the GNU Lesser General Public</span>
<span class="HLcomments">! License along with this library; if not, write to the Free Software</span>
<span class="HLcomments">! Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA</span>

<span class="HLroutines">program</span> example2

	<span class="HLcomments">! This simple example shows how to use PCA and SVD from this package.</span>
	<span class="HLcomments">! Warning: it requires netcdf for in/outputs.</span>
	<span class="HLcomments">!</span>
	<span class="HLcomments">! This example works in a very similar way to the first fortran example,</span>
	<span class="HLcomments">! with the same initial dataset.</span>
	<span class="HLcomments">!</span>
	<span class="HLcomments">! To mimics the use of two different datasets, two geographical</span>
	<span class="HLcomments">! regions are decomposed using SVD. As for MSSA, a pre-PCA is</span>
	<span class="HLcomments">! performed (independantly for the two regions).</span>
	<span class="HLcomments">! One region is situated in the east of the basin, the other</span>
	<span class="HLcomments">! one is on the west.</span>
	<span class="HLcomments">! The dominant EOFs from the SVD decomposition are reconstructed</span>
	<span class="HLcomments">! back to the physical space and stored in the output netcdf file</span>
	<span class="HLcomments">! along with their PCs.</span>
	<span class="HLcomments">!</span>
	<span class="HLcomments">! Note:</span>
	<span class="HLcomments">!	This example should run only a few seconds.</span>
	<span class="HLcomments">!	If it is not the case, your BLAS/LAPACK librairy is not optimized.</span>


	<span class="HLroutines">use</span> spanlib
	<span class="HLroutines">use</span> netcdf

	<span class="HLroutines">implicit</span> <span class="HLattributes">none</span>

	<span class="HLcomments">! Parameters</span>
	<span class="HLcomments">! ----------</span>
	<span class="HLroutines">integer</span>,<span class="HLattributes">parameter</span> :: pcaNkeep=<span class="HLdigits">10</span>, svdNkeep=<span class="HLdigits">5</span>,&amp;
		&amp; lons1(<span class="HLdigits">2</span>)=(/<span class="HLdigits">70</span>,<span class="HLdigits">150</span>/),lats1(<span class="HLdigits">2</span>)=(/<span class="HLdigits">16</span>,<span class="HLdigits">45</span>/),&amp; <span class="HLcomments">! East</span>
		&amp; lons2(<span class="HLdigits">2</span>)=(/<span class="HLdigits">10</span>,<span class="HLdigits">40</span>/),lats2(<span class="HLdigits">2</span>)=(/<span class="HLdigits">12</span>,<span class="HLdigits">49</span>/)    <span class="HLcomments">! West</span>
	<span class="HLroutines">real</span>(wp), <span class="HLattributes">parameter</span> ::new_missing_value=-<span class="HLdigits">999</span>.d0
	<span class="HLroutines">character</span>(len=<span class="HLdigits">20</span>), <span class="HLattributes">parameter</span> :: input_nc_file=<span class="HLstrings">"data2.cdf"</span>, &amp;
		&amp; output_nc_file=<span class="HLstrings">"output_fortran2.nc"</span>, var_name=<span class="HLstrings">'ssta'</span>

	<span class="HLcomments">! Other declarations</span>
	<span class="HLcomments">! ------------------</span>
	<span class="HLroutines">real</span>(wp), <span class="HLattributes">allocatable</span> :: lon1(:), lat1(:), &amp;
		&amp; lon2(:), lat2(:), time(:), sst1(:,:,:), sst2(:,:,:)
	<span class="HLroutines">logical</span>, <span class="HLattributes">allocatable</span> :: mask1(:,:),mask2(:,:)
	<span class="HLroutines">real</span>(wp), <span class="HLattributes">allocatable</span> :: packed_sst1(:,:),packed_sst2(:,:),&amp;
		&amp; pcaSstRec1(:,:,:),pcaSstRec2(:,:,:)
	<span class="HLroutines">real</span>(wp), <span class="HLattributes">allocatable</span> :: svdEv(:), &amp;
		&amp; pcaEofs1(:,:),pcaEofs2(:,:),pcaPcs1(:,:),pcaPcs2(:,:), &amp;
		&amp; svdEofs1(:,:),svdEofs2(:,:),svdPcs1(:,:),svdPcs2(:,:)
	<span class="HLroutines">real</span>(wp), <span class="HLattributes">allocatable</span> :: &amp;
		&amp; svdEofsRec1(:,:,:), svdEofsRec2(:,:,:), &amp;
		&amp; packed_svdEofsRec1(:,:), packed_svdEofsRec2(:,:), &amp;
		&amp; packed_svdSstRec1(:,:), packed_svdSstRec2(:,:), &amp;
		&amp; packed_pcaSstRec1(:,:), packed_pcaSstRec2(:,:)
	<span class="HLroutines">character</span>(len=<span class="HLdigits">20</span>) :: lon_units, lat_units, var_units, &amp;
		&amp;	lon_name, lat_name, time_name, time_units
	<span class="HLroutines">integer</span> :: ncid, dimids(<span class="HLdigits">6</span>), varids(<span class="HLdigits">6</span>), sstids(<span class="HLdigits">9</span>)
	<span class="HLroutines">integer</span>(kind=<span class="HLdigits">4</span>) :: i,nlon1,nlat1,nlon2,nlat2,ntime,ns1,ns2
	<span class="HLroutines">real</span>(wp) :: missing_value

	<span class="HLcomments">! Precision</span>
	<span class="HLcomments">! ---------</span>
	<span class="HLroutines">if</span>(wp==<span class="HLdigits">8</span>)<span class="HLroutines">then</span>
		<span class="HLroutines">print</span>*,<span class="HLstrings">'Using double precision'</span>
	<span class="HLroutines">else</span>
		<span class="HLroutines">print</span>*,<span class="HLstrings">'Using simple precision'</span>
	<span class="HLroutines">end</span> <span class="HLroutines">if</span>

	<span class="HLcomments">! Get the initial sst field from the netcdf file</span>
	<span class="HLcomments">! ----------------------------------------------</span>
	<span class="HLroutines">print</span>*,<span class="HLstrings">'Reading inputs...'</span>
	<span class="HLroutines">call</span> err(nf90_open(input_nc_file, nf90_nowrite, ncid))
	<span class="HLroutines">call</span> err(nf90_inq_varid(ncid, var_name, sstids(<span class="HLdigits">1</span>)))
	<span class="HLcomments">! Dimensions</span>
	nlon1 = lons1(<span class="HLdigits">2</span>)-lons1(<span class="HLdigits">1</span>)+<span class="HLdigits">1</span> ;	nlat1 = lats1(<span class="HLdigits">2</span>)-lats1(<span class="HLdigits">1</span>)+<span class="HLdigits">1</span>
	nlon2 = lons2(<span class="HLdigits">2</span>)-lons2(<span class="HLdigits">1</span>)+<span class="HLdigits">1</span> ; nlat2 = lats2(<span class="HLdigits">2</span>)-lats2(<span class="HLdigits">1</span>)+<span class="HLdigits">1</span>
	<span class="HLroutines">call</span> err(nf90_inquire_variable(ncid, sstids(<span class="HLdigits">1</span>), dimids=dimids(<span class="HLdigits">1</span>:<span class="HLdigits">3</span>)))
	<span class="HLroutines">call</span> err(nf90_inquire_dimension(ncid,dimids(<span class="HLdigits">1</span>),name=lon_name))
	<span class="HLroutines">call</span> err(nf90_inquire_dimension(ncid,dimids(<span class="HLdigits">2</span>),name=lat_name))
	<span class="HLroutines">call</span> err(nf90_inquire_dimension(ncid, dimids(<span class="HLdigits">3</span>), &amp;
		&amp;	name=time_name, len=ntime))
	<span class="HLcomments">! Allocations</span>
	<span class="HLfunctions">allocate</span>(sst1(nlon1,nlat1,ntime),sst2(nlon2,nlat2,ntime))
	<span class="HLfunctions">allocate</span>(mask1(nlon1,nlat1),mask2(nlon2,nlat2))
	<span class="HLfunctions">allocate</span>(lon1(nlon1),lat1(nlat1))
	<span class="HLfunctions">allocate</span>(lon2(nlon2),lat2(nlat2))
	<span class="HLfunctions">allocate</span>(time(ntime))
	<span class="HLcomments">! SST boxes and attributes</span>
	<span class="HLroutines">call</span> err(nf90_get_var(ncid, sstids(<span class="HLdigits">1</span>), sst1,&amp;
		&amp; start=(/lons1(<span class="HLdigits">1</span>),lats1(<span class="HLdigits">1</span>),<span class="HLdigits">1</span>/), &amp;
		&amp; count=(/lons1(<span class="HLdigits">2</span>)-lons1(<span class="HLdigits">1</span>)+<span class="HLdigits">1</span>,lats1(<span class="HLdigits">2</span>)-lats1(<span class="HLdigits">1</span>)+<span class="HLdigits">1</span>,ntime/)))
	<span class="HLroutines">call</span> err(nf90_get_var(ncid, sstids(<span class="HLdigits">1</span>), sst2,&amp;
		&amp; start=(/lons2(<span class="HLdigits">1</span>),lats2(<span class="HLdigits">1</span>),<span class="HLdigits">1</span>/), &amp;
		&amp; count=(/lons2(<span class="HLdigits">2</span>)-lons2(<span class="HLdigits">1</span>)+<span class="HLdigits">1</span>,lats2(<span class="HLdigits">2</span>)-lats2(<span class="HLdigits">1</span>)+<span class="HLdigits">1</span>,ntime/)))
	<span class="HLroutines">call</span> err(nf90_get_att(ncid,sstids(<span class="HLdigits">1</span>),<span class="HLstrings">'missing_value'</span>,missing_value))
	<span class="HLroutines">call</span> err(nf90_get_att(ncid,sstids(<span class="HLdigits">1</span>),<span class="HLstrings">'units'</span>,var_units))
	<span class="HLcomments">! Longitudes</span>
	<span class="HLroutines">call</span> err(nf90_inq_varid(ncid, lon_name, varids(<span class="HLdigits">1</span>)))
	<span class="HLroutines">call</span> err(nf90_get_var(ncid, varids(<span class="HLdigits">1</span>), lon1, &amp;
		&amp; start=(/lons1(<span class="HLdigits">1</span>)/), count=(/lons1(<span class="HLdigits">2</span>)-lons1(<span class="HLdigits">1</span>)+<span class="HLdigits">1</span>/)))
	<span class="HLroutines">call</span> err(nf90_get_att(ncid, varids(<span class="HLdigits">1</span>), <span class="HLstrings">'units'</span>, lon_units))
	<span class="HLroutines">call</span> err(nf90_get_var(ncid, varids(<span class="HLdigits">1</span>), lon2, &amp;
		&amp; start=(/lons2(<span class="HLdigits">1</span>)/), count=(/lons2(<span class="HLdigits">2</span>)-lons2(<span class="HLdigits">1</span>)+<span class="HLdigits">1</span>/)))
	<span class="HLcomments">! Latitudes</span>
	<span class="HLroutines">call</span> err(nf90_inq_varid(ncid, lat_name, varids(<span class="HLdigits">1</span>)))
	<span class="HLroutines">call</span> err(nf90_get_var(ncid, varids(<span class="HLdigits">1</span>), lat1, &amp;
		&amp; start=(/lats1(<span class="HLdigits">1</span>)/), count=(/lats1(<span class="HLdigits">2</span>)-lats1(<span class="HLdigits">1</span>)+<span class="HLdigits">1</span>/)))
	<span class="HLroutines">call</span> err(nf90_get_att(ncid, varids(<span class="HLdigits">1</span>), <span class="HLstrings">'units'</span>, lat_units))
	<span class="HLroutines">call</span> err(nf90_get_var(ncid, varids(<span class="HLdigits">1</span>), lat2, &amp;
		&amp; start=(/lats2(<span class="HLdigits">1</span>)/), count=(/lats2(<span class="HLdigits">2</span>)-lats2(<span class="HLdigits">1</span>)+<span class="HLdigits">1</span>/)))
	<span class="HLcomments">! Time</span>
	<span class="HLroutines">call</span> err(nf90_inq_varid(ncid, time_name, varids(<span class="HLdigits">1</span>)))
	<span class="HLroutines">call</span> err(nf90_get_var(ncid, varids(<span class="HLdigits">1</span>), time))
	<span class="HLroutines">call</span> err(nf90_get_att(ncid, varids(<span class="HLdigits">1</span>), <span class="HLstrings">'units'</span>, time_units))
	<span class="HLroutines">call</span> err(nf90_close(ncid))


	<span class="HLcomments">! Format (pack) data to have only one space dimension</span>
	<span class="HLcomments">! ---------------------------------------------------</span>
	<span class="HLroutines">print</span>*,<span class="HLstrings">'Packing...'</span>
	mask1 = (sst1(:,:,<span class="HLdigits">1</span>) /= missing_value)
	mask2 = (sst2(:,:,<span class="HLdigits">1</span>) /= missing_value)
	ns1 = count(mask1) ; ns2 = count(mask2)
	<span class="HLfunctions">allocate</span>(packed_sst1(ns1, ntime))
	<span class="HLfunctions">allocate</span>(packed_sst2(ns2, ntime))
	<span class="HLroutines">do</span> i=<span class="HLdigits">1</span>, ntime
		packed_sst1(:,i) = <span class="HLfunctions">pack</span>(sst1(:,:,i), mask1)
		packed_sst2(:,i) = <span class="HLfunctions">pack</span>(sst2(:,:,i), mask2)
	<span class="HLroutines">end</span> <span class="HLroutines">do</span>
	where(sst1==missing_value)sst1 = new_missing_value
	where(sst2==missing_value)sst2 = new_missing_value

	<span class="HLcomments">! Perform a PCA to reduce the d.o.f</span>
	<span class="HLcomments">! ---------------------------------</span>
	<span class="HLroutines">print</span>*,<span class="HLstrings">'[<span class="HLpersonalised">sl_pca</span>] Pre-PCA ...'</span>
	<span class="HLfunctions">allocate</span>(pcaEofs1(ns1, pcaNkeep))
	<span class="HLfunctions">allocate</span>(pcaPcs1(ntime,pcaNkeep))
	<span class="HLroutines">call</span> <span class="HLpersonalised">sl_pca</span>(packed_sst1, pcaNkeep, xeof=pcaEofs1, pc=pcaPcs1)
	<span class="HLfunctions">allocate</span>(pcaEofs2(ns2, pcaNkeep))
	<span class="HLfunctions">allocate</span>(pcaPcs2(ntime,pcaNkeep))
	<span class="HLroutines">call</span> <span class="HLpersonalised">sl_pca</span>(packed_sst2, pcaNkeep, xeof=pcaEofs2, pc=pcaPcs2)
	<span class="HLfunctions">deallocate</span>(packed_sst1,packed_sst2)


	<span class="HLcomments">! Perform a SVD on previous PCs</span>
	<span class="HLcomments">! -----------------------------</span>
	<span class="HLroutines">print</span>*,<span class="HLstrings">'[<span class="HLpersonalised">sl_svd</span>] SVD...'</span>
	<span class="HLfunctions">allocate</span>(svdEofs1(pcaNkeep,svdNkeep),svdPcs1(ntime,svdNkeep))
	<span class="HLfunctions">allocate</span>(svdEofs2(pcaNkeep,svdNkeep),svdPcs2(ntime,svdNkeep))
	<span class="HLfunctions">allocate</span>(svdEv(svdNkeep))
	<span class="HLroutines">call</span> <span class="HLpersonalised">sl_svd</span>(<span class="HLfunctions">transpose</span>(pcaPcs1),<span class="HLfunctions">transpose</span>(pcaPcs2),&amp;
		&amp; svdNkeep,leof=svdEofs1,reof=svdEofs2,&amp;
		&amp; lpc=svdPcs1,rpc=svdPcs2,ev=svdEv)
	<span class="HLfunctions">deallocate</span>(pcaPcs1,pcaPcs2)

	<span class="HLcomments">! Swicth SVD EOFs to the physical space (!)</span>
	<span class="HLcomments">! -----------------------------------------</span>
	<span class="HLroutines">print</span>*,<span class="HLstrings">'[<span class="HLpersonalised">sl_pca_rec</span>] Back EOF to the physical space ...'</span>
	<span class="HLfunctions">allocate</span>(packed_svdEofsRec1(ns1,svdNkeep))
	<span class="HLfunctions">allocate</span>(packed_svdEofsRec2(ns2,svdNkeep))
	<span class="HLroutines">call</span> <span class="HLpersonalised">sl_pca_rec</span>(pcaEofs1, <span class="HLfunctions">transpose</span>(svdEofs1), packed_svdEofsRec1)
	<span class="HLroutines">call</span> <span class="HLpersonalised">sl_pca_rec</span>(pcaEofs2, <span class="HLfunctions">transpose</span>(svdEofs2), packed_svdEofsRec2)

	<span class="HLcomments">! Switch SST to the physical space</span>
	<span class="HLcomments">! --------------------------------</span>
	<span class="HLcomments">! SVD to pre-PCA</span>
	<span class="HLroutines">print</span>*,<span class="HLstrings">'[<span class="HLpersonalised">sl_pca_rec</span>] Back SST to the physical space ...'</span>
	<span class="HLfunctions">allocate</span>(packed_svdSstRec1(pcaNkeep,ntime))
	<span class="HLfunctions">allocate</span>(packed_svdSstRec2(pcaNkeep,ntime))
	<span class="HLroutines">call</span> <span class="HLpersonalised">sl_pca_rec</span>(svdEofs1,svdPcs1,packed_svdSstRec1)
	<span class="HLroutines">call</span> <span class="HLpersonalised">sl_pca_rec</span>(svdEofs2,svdPcs2,packed_svdSstRec2)
	<span class="HLcomments">! Pre-PCA to physical</span>
	<span class="HLfunctions">allocate</span>(packed_pcaSstRec1(ns1,ntime),packed_pcaSstRec2(ns2,ntime))
	<span class="HLroutines">call</span> <span class="HLpersonalised">sl_pca_rec</span>(pcaEofs1,<span class="HLfunctions">transpose</span>(packed_svdSstRec1),&amp;
		&amp; packed_pcaSstRec1)
	<span class="HLroutines">call</span> <span class="HLpersonalised">sl_pca_rec</span>(pcaEofs2,<span class="HLfunctions">transpose</span>(packed_svdSstRec2),&amp;
		&amp; packed_pcaSstRec2)
	<span class="HLfunctions">deallocate</span>(pcaEofs1,svdEofs1,pcaEofs2,svdEofs2)
	<span class="HLfunctions">deallocate</span>(packed_svdSstRec1,packed_svdSstRec2)

	<span class="HLcomments">! Unpacking</span>
	<span class="HLcomments">! ---------</span>
	<span class="HLroutines">print</span>*,<span class="HLstrings">'Unpacking...'</span>
	<span class="HLfunctions">allocate</span>(svdEofsRec1(nlon1,nlat1,svdNkeep))
	<span class="HLfunctions">allocate</span>(svdEofsRec2(nlon2,nlat2,svdNkeep))
	<span class="HLfunctions">allocate</span>(pcaSstRec1(nlon1,nlat1,ntime))
	<span class="HLfunctions">allocate</span>(pcaSstRec2(nlon2,nlat2,ntime))
	<span class="HLcomments">! Eofs</span>
	<span class="HLroutines">do</span> i=<span class="HLdigits">1</span>, svdNkeep
		svdEofsRec1(:,:,i) = <span class="HLfunctions">unpack</span>(packed_svdEofsRec1(:,i), &amp;
			&amp; mask1, new_missing_value)
		svdEofsRec2(:,:,i) = <span class="HLfunctions">unpack</span>(packed_svdEofsRec2(:,i), &amp;
			&amp; mask2, new_missing_value)
		where(.<span class="HLfunctions">not</span>.mask1)svdEofsRec1(:,:,i) = new_missing_value
		where(.<span class="HLfunctions">not</span>.mask2)svdEofsRec2(:,:,i) = new_missing_value
	<span class="HLroutines">end</span> <span class="HLroutines">do</span>
	<span class="HLcomments">! SST</span>
	<span class="HLroutines">do</span> i=<span class="HLdigits">1</span>, ntime
		pcaSstRec1(:,:,i) = <span class="HLfunctions">unpack</span>(packed_pcaSstRec1(:,i), &amp;
			&amp; mask1, new_missing_value)
		pcaSstRec2(:,:,i) = <span class="HLfunctions">unpack</span>(packed_pcaSstRec2(:,i), &amp;
			&amp; mask2, new_missing_value)
		where(.<span class="HLfunctions">not</span>.mask1)pcaSstRec1(:,:,i) = new_missing_value
		where(.<span class="HLfunctions">not</span>.mask2)pcaSstRec2(:,:,i) = new_missing_value
	<span class="HLroutines">end</span> <span class="HLroutines">do</span>



	<span class="HLcomments">! Write out the phase composites of the first oscillation</span>
	<span class="HLcomments">! -------------------------------------------------------</span>
	<span class="HLroutines">print</span>*,<span class="HLstrings">'Writing out...'</span>
	<span class="HLcomments">! File</span>
	<span class="HLroutines">call</span> err(nf90_create(output_nc_file, nf90_write, ncid))
	<span class="HLcomments">! Dimensions</span>
	<span class="HLroutines">call</span> err(nf90_def_dim(ncid, <span class="HLstrings">'lon_box1'</span>, nlon1, dimids(<span class="HLdigits">1</span>)))
	<span class="HLroutines">call</span> err(nf90_def_dim(ncid, <span class="HLstrings">'lat_box1'</span>, nlat1, dimids(<span class="HLdigits">2</span>)))
	<span class="HLroutines">call</span> err(nf90_def_dim(ncid, <span class="HLstrings">'lon_box2'</span>, nlon2, dimids(<span class="HLdigits">3</span>)))
	<span class="HLroutines">call</span> err(nf90_def_dim(ncid, <span class="HLstrings">'lat_box2'</span>, nlat2, dimids(<span class="HLdigits">4</span>)))
	<span class="HLroutines">call</span> err(nf90_def_dim(ncid, <span class="HLstrings">'time'</span>, ntime, dimids(<span class="HLdigits">5</span>)))
	<span class="HLroutines">call</span> err(nf90_def_dim(ncid, <span class="HLstrings">'mode'</span>, svdNkeep, dimids(<span class="HLdigits">6</span>)))

	<span class="HLcomments">! Box 1</span>
	<span class="HLroutines">call</span> err(nf90_def_var(ncid, <span class="HLstrings">'lon_box1'</span>, nf90_float, dimids(<span class="HLdigits">1</span>), &amp;
		&amp; varids(<span class="HLdigits">1</span>)))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, varids(<span class="HLdigits">1</span>), <span class="HLstrings">'long_name'</span>, &amp;
		&amp; <span class="HLstrings">'Longitude'</span>))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, varids(<span class="HLdigits">1</span>), <span class="HLstrings">'units'</span>, lon_units))
	<span class="HLroutines">call</span> err(nf90_def_var(ncid, <span class="HLstrings">'lat_box1'</span>, nf90_float, dimids(<span class="HLdigits">2</span>), &amp;
		&amp; varids(<span class="HLdigits">2</span>)))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, varids(<span class="HLdigits">2</span>), <span class="HLstrings">'long_name'</span>, &amp;
		&amp; <span class="HLstrings">'Latitude'</span>))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, varids(<span class="HLdigits">2</span>), <span class="HLstrings">'units'</span>, lat_units))
	<span class="HLcomments">! Box 2</span>
	<span class="HLroutines">call</span> err(nf90_def_var(ncid, <span class="HLstrings">'lon_box2'</span>, nf90_float, dimids(<span class="HLdigits">3</span>), &amp;
		&amp; varids(<span class="HLdigits">3</span>)))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, varids(<span class="HLdigits">3</span>), <span class="HLstrings">'long_name'</span>, &amp;
		&amp; <span class="HLstrings">'Longitude'</span>))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, varids(<span class="HLdigits">3</span>), <span class="HLstrings">'units'</span>, lon_units))
	<span class="HLroutines">call</span> err(nf90_def_var(ncid, <span class="HLstrings">'lat_box2'</span>, nf90_float, dimids(<span class="HLdigits">4</span>), &amp;
		&amp; varids(<span class="HLdigits">4</span>)))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, varids(<span class="HLdigits">4</span>), <span class="HLstrings">'long_name'</span>, &amp;
		&amp; <span class="HLstrings">'Latitude'</span>))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, varids(<span class="HLdigits">4</span>), <span class="HLstrings">'units'</span>, lat_units))
	<span class="HLcomments">! Time</span>
	<span class="HLroutines">call</span> err(nf90_def_var(ncid, <span class="HLstrings">'time'</span>, nf90_float, dimids(<span class="HLdigits">5</span>), &amp;
		&amp; varids(<span class="HLdigits">5</span>)))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, varids(<span class="HLdigits">5</span>), <span class="HLstrings">'long_name'</span>, <span class="HLstrings">'Time'</span>))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, varids(<span class="HLdigits">5</span>), <span class="HLstrings">'units'</span>, time_units))
	<span class="HLcomments">! Mode</span>
	<span class="HLroutines">call</span> err(nf90_def_var(ncid, <span class="HLstrings">'mode'</span>, nf90_float, dimids(<span class="HLdigits">6</span>), &amp;
		&amp; varids(<span class="HLdigits">6</span>)))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, varids(<span class="HLdigits">6</span>), <span class="HLstrings">'long_name'</span>, <span class="HLstrings">'Mode'</span>))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, varids(<span class="HLdigits">6</span>), <span class="HLstrings">'units'</span>, <span class="HLstrings">'level'</span>))
	<span class="HLcomments">! Original fields</span>
	<span class="HLcomments">! * box1</span>
	<span class="HLroutines">call</span> err(nf90_def_var(ncid, <span class="HLstrings">'sst_box1'</span>, nf90_float, &amp;
		&amp; (/dimids(<span class="HLdigits">1</span>),dimids(<span class="HLdigits">2</span>),dimids(<span class="HLdigits">5</span>)/), sstids(<span class="HLdigits">1</span>)))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, sstids(<span class="HLdigits">1</span>), <span class="HLstrings">'long_name'</span>, &amp;
		&amp; <span class="HLstrings">'SST anomaly / original field / box <span class="HLdigits">1</span>'</span>))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, sstids(<span class="HLdigits">1</span>), <span class="HLstrings">'units'</span>, var_units))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, sstids(<span class="HLdigits">1</span>), <span class="HLstrings">'missing_value'</span>, &amp;
		&amp; new_missing_value))
	<span class="HLcomments">! * box2</span>
	<span class="HLroutines">call</span> err(nf90_def_var(ncid, <span class="HLstrings">'sst_box2'</span>, nf90_float, &amp;
	 &amp; (/dimids(<span class="HLdigits">3</span>),dimids(<span class="HLdigits">4</span>),dimids(<span class="HLdigits">5</span>)/), sstids(<span class="HLdigits">2</span>)))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, sstids(<span class="HLdigits">2</span>), <span class="HLstrings">'long_name'</span>, &amp;
		&amp; <span class="HLstrings">'SST anomaly / original field / box <span class="HLdigits">2</span>'</span>))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, sstids(<span class="HLdigits">2</span>), <span class="HLstrings">'units'</span>, var_units))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, sstids(<span class="HLdigits">2</span>), <span class="HLstrings">'missing_value'</span>, &amp;
		&amp; new_missing_value))
	<span class="HLcomments">! SVD EOFs</span>
	<span class="HLcomments">! * box1</span>
	<span class="HLroutines">call</span> err(nf90_def_var(ncid, <span class="HLstrings">'eofs_box1'</span>, nf90_float, &amp;
	 &amp; (/dimids(<span class="HLdigits">1</span>),dimids(<span class="HLdigits">2</span>),dimids(<span class="HLdigits">6</span>)/),sstids(<span class="HLdigits">3</span>)))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, sstids(<span class="HLdigits">3</span>), <span class="HLstrings">'long_name'</span>, &amp;
		&amp; <span class="HLstrings">'SVD EOFs of SST anomaly / box <span class="HLdigits">1</span>'</span>))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, sstids(<span class="HLdigits">3</span>), <span class="HLstrings">'missing_value'</span>, &amp;
		&amp; new_missing_value))
	<span class="HLcomments">! * box2</span>
	<span class="HLroutines">call</span> err(nf90_def_var(ncid, <span class="HLstrings">'eofs_box2'</span>, nf90_float, &amp;
	 &amp; (/dimids(<span class="HLdigits">3</span>),dimids(<span class="HLdigits">4</span>),dimids(<span class="HLdigits">6</span>)/),sstids(<span class="HLdigits">4</span>)))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, sstids(<span class="HLdigits">4</span>), <span class="HLstrings">'long_name'</span>, &amp;
		&amp; <span class="HLstrings">'SVD EOFs of SST anomaly / box <span class="HLdigits">2</span>'</span>))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, sstids(<span class="HLdigits">4</span>), <span class="HLstrings">'missing_value'</span>, &amp;
		&amp; new_missing_value))
	<span class="HLcomments">! SVD PCs</span>
	<span class="HLcomments">! * Box 1</span>
	<span class="HLroutines">call</span> err(nf90_def_var(ncid, <span class="HLstrings">'pcs_box1'</span>, nf90_float, &amp;
		&amp; (/dimids(<span class="HLdigits">5</span>),dimids(<span class="HLdigits">6</span>)/),sstids(<span class="HLdigits">5</span>)))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, sstids(<span class="HLdigits">5</span>), <span class="HLstrings">'long_name'</span>, &amp;
		&amp; <span class="HLstrings">'SVD EOFs of SST anomaly / box <span class="HLdigits">1</span>'</span>))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, sstids(<span class="HLdigits">5</span>), <span class="HLstrings">'units'</span>, var_units))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, sstids(<span class="HLdigits">5</span>), <span class="HLstrings">'missing_value'</span>, &amp;
		&amp; new_missing_value))
	<span class="HLcomments">! * Box 2</span>
	<span class="HLroutines">call</span> err(nf90_def_var(ncid, <span class="HLstrings">'pcs_box2'</span>, nf90_float, &amp;
		&amp; (/dimids(<span class="HLdigits">5</span>),dimids(<span class="HLdigits">6</span>)/),sstids(<span class="HLdigits">6</span>)))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, sstids(<span class="HLdigits">6</span>), <span class="HLstrings">'long_name'</span>, &amp;
		&amp; <span class="HLstrings">'SVD EOFs of SST anomaly / box <span class="HLdigits">2</span>'</span>))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, sstids(<span class="HLdigits">6</span>), <span class="HLstrings">'units'</span>, var_units))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, sstids(<span class="HLdigits">6</span>), <span class="HLstrings">'missing_value'</span>, &amp;
		&amp; new_missing_value))
	<span class="HLcomments">! SVD eigen values</span>
	<span class="HLroutines">call</span> err(nf90_def_var(ncid, <span class="HLstrings">'ev'</span>, nf90_float, &amp;
		&amp; dimids(<span class="HLdigits">6</span>),sstids(<span class="HLdigits">7</span>)))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, sstids(<span class="HLdigits">7</span>), <span class="HLstrings">'long_name'</span>, &amp;
		&amp; <span class="HLstrings">'Eigen values'</span>))
	<span class="HLcomments">! Reconstructed SST</span>
	<span class="HLcomments">! * box1</span>
	<span class="HLroutines">call</span> err(nf90_def_var(ncid, <span class="HLstrings">'sstrec_box1'</span>, nf90_float, &amp;
	 &amp; (/dimids(<span class="HLdigits">1</span>),dimids(<span class="HLdigits">2</span>),dimids(<span class="HLdigits">5</span>)/),sstids(<span class="HLdigits">8</span>)))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, sstids(<span class="HLdigits">8</span>), <span class="HLstrings">'long_name'</span>, &amp;
		&amp; <span class="HLstrings">'Reconstructed SST anomaly / box <span class="HLdigits">1</span>'</span>))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, sstids(<span class="HLdigits">8</span>), <span class="HLstrings">'missing_value'</span>, &amp;
		&amp; new_missing_value))
	<span class="HLcomments">! * box2</span>
	<span class="HLroutines">call</span> err(nf90_def_var(ncid, <span class="HLstrings">'sstrec_box2'</span>, nf90_float, &amp;
	 &amp; (/dimids(<span class="HLdigits">3</span>),dimids(<span class="HLdigits">4</span>),dimids(<span class="HLdigits">5</span>)/),sstids(<span class="HLdigits">9</span>)))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, sstids(<span class="HLdigits">9</span>), <span class="HLstrings">'long_name'</span>, &amp;
		&amp; <span class="HLstrings">'Reconstructed SST anomaly / box <span class="HLdigits">2</span>'</span>))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, sstids(<span class="HLdigits">9</span>), <span class="HLstrings">'missing_value'</span>, &amp;
		&amp; new_missing_value))


	<span class="HLcomments">! Values</span>
	<span class="HLroutines">call</span> err(nf90_enddef(ncid))
	<span class="HLroutines">call</span> err(nf90_put_var(ncid, varids(<span class="HLdigits">1</span>), lon1))
	<span class="HLroutines">call</span> err(nf90_put_var(ncid, varids(<span class="HLdigits">2</span>), lat1))
	<span class="HLroutines">call</span> err(nf90_put_var(ncid, varids(<span class="HLdigits">3</span>), lon2))
	<span class="HLroutines">call</span> err(nf90_put_var(ncid, varids(<span class="HLdigits">4</span>), lat2))
	<span class="HLroutines">call</span> err(nf90_put_var(ncid, varids(<span class="HLdigits">5</span>), time))
	<span class="HLroutines">call</span> err(nf90_put_var(ncid, varids(<span class="HLdigits">6</span>), &amp;
		&amp; float((/(i,i=<span class="HLdigits">1</span>,svdNkeep)/))))
	<span class="HLroutines">call</span> err(nf90_put_var(ncid, sstids(<span class="HLdigits">1</span>), sst1))
	<span class="HLroutines">call</span> err(nf90_put_var(ncid, sstids(<span class="HLdigits">2</span>), sst2))
	<span class="HLroutines">call</span> err(nf90_put_var(ncid, sstids(<span class="HLdigits">3</span>), svdEofsRec1))
	<span class="HLroutines">call</span> err(nf90_put_var(ncid, sstids(<span class="HLdigits">4</span>), svdEofsRec2))
	<span class="HLroutines">call</span> err(nf90_put_var(ncid, sstids(<span class="HLdigits">5</span>), svdPcs1))
	<span class="HLroutines">call</span> err(nf90_put_var(ncid, sstids(<span class="HLdigits">6</span>), svdPcs2))
	<span class="HLroutines">call</span> err(nf90_put_var(ncid, sstids(<span class="HLdigits">7</span>), svdEv))
	<span class="HLroutines">call</span> err(nf90_put_var(ncid, sstids(<span class="HLdigits">8</span>), pcaSstRec1))
	<span class="HLroutines">call</span> err(nf90_put_var(ncid, sstids(<span class="HLdigits">9</span>), pcaSstRec2))

	<span class="HLroutines">call</span> err(nf90_close(ncid))

<span class="HLroutines">end</span> <span class="HLroutines">program</span> example2

<span class="HLroutines">subroutine</span> err(jstatus)

	<span class="HLroutines">use</span> netcdf

	<span class="HLroutines">integer</span> :: jstatus

	<span class="HLroutines">if</span> (jstatus .ne. nf90_noerr) <span class="HLroutines">then</span>
		<span class="HLroutines">print</span> *, <span class="HLfunctions">trim</span>(nf90_strerror(jstatus))
		stop
	<span class="HLroutines">end</span> <span class="HLroutines">if</span>

<span class="HLroutines">end</span> <span class="HLroutines">subroutine</span> err

</pre>
              <p>
					</p>
            </div>
          </div>
        </div>
      </div>
      <div class="sect1" lang="en" xml:lang="en">
        <div class="titlepage">
          <div>
            <div>
              <h2 class="title" style="clear: both"><a id="doc_pyt"></a>4. The python module</h2>
            </div>
          </div>
        </div>
        <div class="sect2" lang="en" xml:lang="en">
          <div class="titlepage">
            <div>
              <div>
                <h3 class="title"><a id="doc_pyt_int"></a>4.1. Introduction</h3>
              </div>
            </div>
          </div>
          <p>
				The intent of the python module is to offer
				a scripting interface to the F90 subroutines.
				It takes advantage of the power of python and
				of the computational efficiency of fortran.
			</p>
          <p>
				Thanks to the use of CDAT, the module easily handle
				gridded dataset, using masks and weights for example.
				It also allows the analysis of several datasets at the
				same time by stacking them.
				The module performs some tasks in a transparant way:
				packing and unpacking of data, PCA reduction before MSSA anaysis, etc.
			</p>
          <div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3>
				The current version of this module only manage 3D dataset:
				first two dimensions for "space", the last dimension for time.
			</div>
        </div>
        <div class="sect2" lang="en" xml:lang="en">
          <div class="titlepage">
            <div>
              <div>
                <h3 class="title"><a id="doc_pyt_sub"></a>4.2. Python functions</h3>
              </div>
            </div>
          </div>
          <div class="sect3" lang="en" xml:lang="en">
            <div class="titlepage">
              <div>
                <div>
                  <h4 class="title"><a id="spanlib.stackData"></a>4.2.1.  Takes several data files, of same time and stacks them up together: <code class="literal">spanlib.stackData</code></h4>
                </div>
              </div>
            </div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="id3043895"></a>Usage</h5>
                  </div>
                </div>
              </div>
              <pre class="programlisting"><span class="HLpersonalised">dout</span>, <span class="HLpersonalised">weights</span>, <span class="HLpersonalised">masks</span>, <span class="HLpersonalised">axes</span> = <span class="HLpersonalised">spanlib.stackData</span>(*<span class="HLpersonalised">data</span>)</pre>
            </div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="id3064052"></a>Description</h5>
                  </div>
                </div>
              </div>
              <p>      This fonction concatenates several dataset that have the
      same time axis. It is useful for analysing for example
      several variables at the same time.
      It takes into account weights, masks and axes.
</p>
            </div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="id3064067"></a>Necessary arguments</h5>
                  </div>
                </div>
              </div>
              <div class="itemizedlist">
                <ul type="disc">
                  <li><code class="varname">*data    </code><code class="option"><span class="ARGspec">[intent:input]    </span></code> 
				 :: <span class="emphasis"><em> One or more data objects to stack.
                 They must all have the same time length.
</em></span></li>
                </ul>
              </div>
            </div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="id3051694"></a>Outputs</h5>
                  </div>
                </div>
              </div>
              <div class="itemizedlist">
                <ul type="disc">
                  <li><code class="varname">dout    </code><code class="option"><span class="ARGspec">[intent:output]    </span></code> 
				 :: <span class="emphasis"><em> Stacked data
</em></span></li>
                  <li><code class="varname">weights    </code><code class="option"><span class="ARGspec">[intent:output]    </span></code> 
				 :: <span class="emphasis"><em> Associated stacked weights
</em></span></li>
                  <li><code class="varname">masks    </code><code class="option"><span class="ARGspec">[intent:output]    </span></code> 
				 :: <span class="emphasis"><em> Associated stacked masks
</em></span></li>
                  <li><code class="varname">axes    </code><code class="option"><span class="ARGspec">[intent:output]    </span></code> 
				 :: <span class="emphasis"><em> Associated stacked axes
</em></span></li>
                </ul>
              </div>
            </div>
          </div>
          <div class="sect3" lang="en" xml:lang="en">
            <div class="titlepage">
              <div>
                <div>
                  <h4 class="title"><a id="spanlib.unStackData"></a>4.2.2.  Unstack data in the form returned from stackData: <code class="literal">spanlib.unStackData</code></h4>
                </div>
              </div>
            </div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="id3063540"></a>Usage</h5>
                  </div>
                </div>
              </div>
              <pre class="programlisting"><span class="HLpersonalised">dout</span> = <span class="HLpersonalised">spanlib.unStackData</span>(<span class="HLpersonalised">din</span>, <span class="HLpersonalised">weights</span>, <span class="HLpersonalised">masks</span>, <span class="HLpersonalised">axes</span>)</pre>
            </div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="id3034256"></a>Description</h5>
                  </div>
                </div>
              </div>
              <p>      This function is the reverse operation of stakData.
      It splits stacked datasets into a list.
</p>
            </div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="id3048821"></a>Necessary arguments</h5>
                  </div>
                </div>
              </div>
              <div class="itemizedlist">
                <ul type="disc">
                  <li><code class="varname">din    </code><code class="option"><span class="ARGspec">[intent:input]    </span></code> 
				 :: <span class="emphasis"><em> Stacked data (see stackData function)
</em></span></li>
                  <li><code class="varname">weights    </code><code class="option"><span class="ARGspec">[intent:input]    </span></code> 
				 :: <span class="emphasis"><em> Associated stacked weights
</em></span></li>
                  <li><code class="varname">masks    </code><code class="option"><span class="ARGspec">[intent:input]    </span></code> 
				 :: <span class="emphasis"><em> Associated stacked masks
</em></span></li>
                  <li><code class="varname">axes    </code><code class="option"><span class="ARGspec">[intent:input]    </span></code> 
				 :: <span class="emphasis"><em> Associated stacked axes
</em></span></li>
                </ul>
              </div>
            </div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="id3064640"></a>Outputs</h5>
                  </div>
                </div>
              </div>
              <div class="itemizedlist">
                <ul type="disc">
                  <li><code class="varname">dout    </code><code class="option"><span class="ARGspec">[intent:output]    </span></code> 
				 :: <span class="emphasis"><em> List of unstacked data
</em></span></li>
                </ul>
              </div>
            </div>
          </div>
          <div class="sect3" lang="en" xml:lang="en">
            <div class="titlepage">
              <div>
                <div>
                  <h4 class="title"><a id="spanlib.pack"></a>4.2.3.  Pack a dataset and its weights according to its mask: <code class="literal">spanlib.pack</code></h4>
                </div>
              </div>
            </div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="id3033787"></a>Usage</h5>
                  </div>
                </div>
              </div>
              <pre class="programlisting"><span class="HLpersonalised">packed_data</span>, <span class="HLpersonalised">packed_weights</span>, <span class="HLpersonalised">mask</span> = <span class="HLpersonalised">spanlib.pack</span>(<span class="HLpersonalised">data</span>, <span class="HLpersonalised">weights</span>=<span class="HLpersonalised">None</span>)</pre>
            </div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="id3052128"></a>Description</h5>
                  </div>
                </div>
              </div>
              <p>      This function packs a dataset in 2D space by removing
      all masked points and returning a space-time array.
      It performs this operation also on the weights.
      It is used for removing unnecessary points and
      simplifying the input format for analysis functions.
</p>
            </div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="id3052144"></a>Necessary arguments</h5>
                  </div>
                </div>
              </div>
              <div class="itemizedlist">
                <ul type="disc">
                  <li><code class="varname">data    </code><code class="option"><span class="ARGspec">[intent:input]    </span></code> 
				 :: <span class="emphasis"><em> Flatten in space an [x,y,t] array by removing
                 its masked point
</em></span></li>
                </ul>
              </div>
            </div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="id3056462"></a>Optional arguments</h5>
                  </div>
                </div>
              </div>
              <div class="itemizedlist">
                <ul type="disc">
                  <li><code class="varname">weights    </code><code class="option"><span class="ARGspec">[intent:input, default:<span class="HLpersonalised">None</span>]    </span></code> 
				 :: <span class="emphasis"><em> Weights to be flatten also
</em></span></li>
                </ul>
              </div>
            </div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="id3047901"></a>Outputs</h5>
                  </div>
                </div>
              </div>
              <div class="itemizedlist">
                <ul type="disc">
                  <li><code class="varname">packed_data    </code><code class="option"><span class="ARGspec">[intent:output]    </span></code> 
				 :: <span class="emphasis"><em> Space-time packed array
</em></span></li>
                  <li><code class="varname">packed_weights    </code><code class="option"><span class="ARGspec">[intent:output]    </span></code> 
				 :: <span class="emphasis"><em> Packed weights that were guessed or used
</em></span></li>
                  <li><code class="varname">mask    </code><code class="option"><span class="ARGspec">[intent:output]    </span></code> 
				 :: <span class="emphasis"><em> Mask that were guessed or used
</em></span></li>
                </ul>
              </div>
            </div>
          </div>
          <div class="sect3" lang="en" xml:lang="en">
            <div class="titlepage">
              <div>
                <div>
                  <h4 class="title"><a id="spanlib.computePhases"></a>4.2.4.  Phase composites for oscillatory fields: <code class="literal">spanlib.computePhases</code></h4>
                </div>
              </div>
            </div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="id3041662"></a>Usage</h5>
                  </div>
                </div>
              </div>
              <pre class="programlisting"><span class="HLpersonalised">phases</span> = <span class="HLpersonalised">spanlib.computePhases</span>(<span class="HLpersonalised">data</span>, <span class="HLpersonalised">nphases</span>=<span class="HLpersonalised">8</span>, <span class="HLpersonalised">offset</span>=.<span class="HLpersonalised">5</span>, <span class="HLpersonalised">firstphase</span>=<span class="HLpersonalised">0</span>)</pre>
            </div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="id3062184"></a>Description</h5>
                  </div>
                </div>
              </div>
              <p>      This computes temporal phase composites of a spatio-temporal
      dataset. The dataset is expected to be oscillatory in time.
      It corresponds to a reoganisation of the time axis to
      to represents the dataset over its cycle in a arbitrary
      number of phases. It is useful, for example, to have a
      synthetic view of an reconstructed MSSA oscillation.
</p>
            </div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="id3048431"></a>Necessary arguments</h5>
                  </div>
                </div>
              </div>
              <div class="itemizedlist">
                <ul type="disc">
                  <li><code class="varname">data    </code><code class="option"><span class="ARGspec">[intent:input]    </span></code> 
				 :: <span class="emphasis"><em> Space-time data oscillatory in time data.shape is rank 2 and dim 0 is space
</em></span></li>
                </ul>
              </div>
            </div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="id3048463"></a>Optional arguments</h5>
                  </div>
                </div>
              </div>
              <div class="itemizedlist">
                <ul type="disc">
                  <li><code class="varname">nphases    </code><code class="option"><span class="ARGspec">[intent:input, default:<span class="HLpersonalised">8</span>]    </span></code> 
				 :: <span class="emphasis"><em> Number of phases (divisions of the cycle)
      offset     :: Normalised offset to keep higher values only [default:
</em></span></li>
                  <li><code class="varname">offset    </code><code class="option"><span class="ARGspec">[intent:input, default:<span class="HLpersonalised">.5</span>]    </span></code> 
				 :: <span class="emphasis"><em></em></span></li>
                  <li><code class="varname">firstphase    </code><code class="option"><span class="ARGspec">[intent:input, default:<span class="HLpersonalised">0</span>]    </span></code> 
				 :: <span class="emphasis"><em> Position of the first phase in the 360 degree cycle
</em></span></li>
                </ul>
              </div>
            </div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="id3058520"></a>Outputs</h5>
                  </div>
                </div>
              </div>
              <div class="itemizedlist">
                <ul type="disc">
                  <li><code class="varname">phases    </code><code class="option"><span class="ARGspec">[intent:output]    </span></code> 
				 :: <span class="emphasis"><em> Space-phase array
</em></span></li>
                </ul>
              </div>
            </div>
          </div>
          <div class="sect3" lang="en" xml:lang="en">
            <div class="titlepage">
              <div>
                <div>
                  <h4 class="title"><a id="spanlib.SpAn"></a>4.2.5.  Prepare the Spectral Analysis Object: <code class="literal">spanlib.SpAn</code></h4>
                </div>
              </div>
            </div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="id3054038"></a>Usage</h5>
                  </div>
                </div>
              </div>
              <pre class="programlisting"><span class="HLpersonalised">&lt;SpAn_object&gt;</span> = <span class="HLpersonalised">spanlib.SpAn</span>(<span class="HLpersonalised">data</span>, <span class="HLpersonalised">weights</span>=<span class="HLpersonalised">None</span>, <span class="HLpersonalised">npca</span>=<span class="HLpersonalised">None</span>, <span class="HLpersonalised">window</span>=<span class="HLpersonalised">None</span>, <span class="HLpersonalised">nmssa</span>=<span class="HLpersonalised">None</span>, <span class="HLpersonalised">nsvd</span>=<span class="HLpersonalised">None</span>, <span class="HLpersonalised">relative</span>=<span class="HLpersonalised">False</span>)</pre>
            </div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="id3051367"></a>Description</h5>
                  </div>
                </div>
              </div>
              <p>          This function creates an object for future analyses.
          It optionally initializes some parameters.
</p>
            </div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="id3051380"></a>Necessary arguments</h5>
                  </div>
                </div>
              </div>
              <div class="itemizedlist">
                <ul type="disc">
                  <li><code class="varname">data    </code><code class="option"><span class="ARGspec">[intent:input]    </span></code> 
				 :: <span class="emphasis"><em> List of data on which to run the PC Analysis
                     Last dimensions must represent the spatial dimensions.
                     Analysis will be run on the first dimension.
</em></span></li>
                </ul>
              </div>
            </div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="id3025429"></a>Optional arguments</h5>
                  </div>
                </div>
              </div>
              <div class="itemizedlist">
                <ul type="disc">
                  <li><code class="varname">weights    </code><code class="option"><span class="ARGspec">[intent:input, default:<span class="HLpersonalised">1. everywhere</span>]    </span></code> 
				 :: <span class="emphasis"><em> If you which to apply weights on some points,
                     set weights to "0" where you wish to mask.
                     The input data mask will be applied,
                     using the union of all none spacial dimension mask.
                     If the data are on a regular grid, area weights
                     will be generated, if the cdutil (CDAT) module is available.
                     
          npca    :: Number of principal components to return [default: 10]
          nmssa   :: Number of MSSA modes retained [default: 4]
          nsvd    :: Number of SVD modes retained [default: 10]
          window  :: MSSA window parameter [default: time_length/3.]
</em></span></li>
                  <li><code class="varname">npca    </code><code class="option"><span class="ARGspec">[intent:input, default:<span class="HLpersonalised">None</span>]    </span></code> 
				 :: <span class="emphasis"><em></em></span></li>
                  <li><code class="varname">window    </code><code class="option"><span class="ARGspec">[intent:input, default:<span class="HLpersonalised">None</span>]    </span></code> 
				 :: <span class="emphasis"><em></em></span></li>
                  <li><code class="varname">nmssa    </code><code class="option"><span class="ARGspec">[intent:input, default:<span class="HLpersonalised">None</span>]    </span></code> 
				 :: <span class="emphasis"><em></em></span></li>
                  <li><code class="varname">nsvd    </code><code class="option"><span class="ARGspec">[intent:input, default:<span class="HLpersonalised">None</span>]    </span></code> 
				 :: <span class="emphasis"><em></em></span></li>
                  <li><code class="varname">relative    </code><code class="option"><span class="ARGspec">[intent:input, default:<span class="HLpersonalised">False</span>]    </span></code> 
				 :: <span class="emphasis"><em></em></span></li>
                </ul>
              </div>
            </div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="id2995367"></a>Outputs</h5>
                  </div>
                </div>
              </div>
              <div class="itemizedlist">
                <ul type="disc">
                  <li><code class="varname">&lt;SpAn_object&gt;    </code><code class="option"><span class="ARGspec">[intent:output]    </span></code> 
				 :: <span class="emphasis"><em>Object created for further analysis</em></span></li>
                </ul>
              </div>
            </div>
          </div>
          <div class="sect3" lang="en" xml:lang="en">
            <div class="titlepage">
              <div>
                <div>
                  <h4 class="title"><a id="&lt;SpAn_object&gt;.pca"></a>4.2.6.  Principal Components Analysis (PCA): <code class="literal">&lt;SpAn_object&gt;.pca</code></h4>
                </div>
              </div>
            </div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="id3045092"></a>Usage</h5>
                  </div>
                </div>
              </div>
              <pre class="programlisting"><span class="HLpersonalised">ret</span> = <span class="HLpersonalised">&lt;SpAn_object&gt;.pca</span>(<span class="HLpersonalised">npca</span>=<span class="HLpersonalised">None</span>, <span class="HLpersonalised">get_ev_sum</span>=<span class="HLpersonalised">False</span>, <span class="HLpersonalised">relative</span>=<span class="HLpersonalised">False</span>)</pre>
            </div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="id3045156"></a>Optional arguments</h5>
                  </div>
                </div>
              </div>
              <div class="itemizedlist">
                <ul type="disc">
                  <li><code class="varname">npca    </code><code class="option"><span class="ARGspec">[intent:input, default:<span class="HLpersonalised">None</span>]    </span></code> 
				 :: <span class="emphasis"><em></em></span></li>
                  <li><code class="varname">get_ev_sum    </code><code class="option"><span class="ARGspec">[intent:input, default:<span class="HLpersonalised">False</span>]    </span></code> 
				 :: <span class="emphasis"><em></em></span></li>
                  <li><code class="varname">relative    </code><code class="option"><span class="ARGspec">[intent:input, default:<span class="HLpersonalised">False</span>]    </span></code> 
				 :: <span class="emphasis"><em></em></span></li>
                </ul>
              </div>
            </div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="id3033299"></a>Outputs</h5>
                  </div>
                </div>
              </div>
              <div class="itemizedlist">
                <ul type="disc">
                  <li><code class="varname">ret    </code><code class="option"><span class="ARGspec">[intent:output]    </span></code> 
				 :: <span class="emphasis"><em></em></span></li>
                </ul>
              </div>
            </div>
          </div>
          <div class="sect3" lang="en" xml:lang="en">
            <div class="titlepage">
              <div>
                <div>
                  <h4 class="title"><a id="&lt;SpAn_object&gt;.mssa"></a>4.2.7.  MultiChannel Singular Spectrum Analysis (MSSA): <code class="literal">&lt;SpAn_object&gt;.mssa</code></h4>
                </div>
              </div>
            </div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="id3052766"></a>Usage</h5>
                  </div>
                </div>
              </div>
              <pre class="programlisting"><span class="HLpersonalised">ret</span> = <span class="HLpersonalised">&lt;SpAn_object&gt;.mssa</span>(<span class="HLpersonalised">nmssa</span>=<span class="HLpersonalised">None</span>, <span class="HLpersonalised">pca</span>=<span class="HLpersonalised">None</span>, <span class="HLpersonalised">window</span>=<span class="HLpersonalised">None</span>, <span class="HLpersonalised">get_ev_sum</span>=<span class="HLpersonalised">False</span>, <span class="HLpersonalised">relative</span>=<span class="HLpersonalised">False</span>)</pre>
            </div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="id3064012"></a>Optional arguments</h5>
                  </div>
                </div>
              </div>
              <div class="itemizedlist">
                <ul type="disc">
                  <li><code class="varname">nmssa    </code><code class="option"><span class="ARGspec">[intent:input, default:<span class="HLpersonalised">None</span>]    </span></code> 
				 :: <span class="emphasis"><em> Number of MSSA modes retained
</em></span></li>
                  <li><code class="varname">pca    </code><code class="option"><span class="ARGspec">[intent:input, default:<span class="HLpersonalised">False</span>]    </span></code> 
				 :: <span class="emphasis"><em> If True, performs a preliminary PCA
          get_ev_sum  :: Also return sum of all eigen values (default: False)
          relative :: Egein values are normalized to their sum (%) 

</em></span></li>
                  <li><code class="varname">window    </code><code class="option"><span class="ARGspec">[intent:input, default:<span class="HLpersonalised">None</span>]    </span></code> 
				 :: <span class="emphasis"><em> MSSA window parameter
</em></span></li>
                  <li><code class="varname">get_ev_sum    </code><code class="option"><span class="ARGspec">[intent:input, default:<span class="HLpersonalised">False</span>]    </span></code> 
				 :: <span class="emphasis"><em></em></span></li>
                  <li><code class="varname">relative    </code><code class="option"><span class="ARGspec">[intent:input, default:<span class="HLpersonalised">False</span>]    </span></code> 
				 :: <span class="emphasis"><em></em></span></li>
                </ul>
              </div>
            </div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="id3022491"></a>Outputs</h5>
                  </div>
                </div>
              </div>
              <div class="itemizedlist">
                <ul type="disc">
                  <li><code class="varname">ret    </code><code class="option"><span class="ARGspec">[intent:output]    </span></code> 
				 :: <span class="emphasis"><em></em></span></li>
                </ul>
              </div>
            </div>
          </div>
          <div class="sect3" lang="en" xml:lang="en">
            <div class="titlepage">
              <div>
                <div>
                  <h4 class="title"><a id="&lt;SpAn_object&gt;.svd"></a>4.2.8.  Singular Value Decomposition (SVD): <code class="literal">&lt;SpAn_object&gt;.svd</code></h4>
                </div>
              </div>
            </div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="id3033331"></a>Usage</h5>
                  </div>
                </div>
              </div>
              <pre class="programlisting"><span class="HLpersonalised">eof</span>[<span class="HLpersonalised">0</span>], <span class="HLpersonalised">pc</span>[<span class="HLpersonalised">0</span>], <span class="HLpersonalised">eof</span>[<span class="HLpersonalised">1</span>], <span class="HLpersonalised">pc</span>[<span class="HLpersonalised">1</span>], <span class="HLpersonalised">ev</span> = <span class="HLpersonalised">&lt;SpAn_object&gt;.svd</span>(<span class="HLpersonalised">nsvd</span>=<span class="HLpersonalised">None</span>, <span class="HLpersonalised">pca</span>=<span class="HLpersonalised">None</span>)</pre>
            </div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="id3052202"></a>Optional arguments</h5>
                  </div>
                </div>
              </div>
              <div class="itemizedlist">
                <ul type="disc">
                  <li><code class="varname">nsvd    </code><code class="option"><span class="ARGspec">[intent:input, default:<span class="HLpersonalised">None</span>]    </span></code> 
				 :: <span class="emphasis"><em></em></span></li>
                  <li><code class="varname">pca    </code><code class="option"><span class="ARGspec">[intent:input, default:<span class="HLpersonalised">None</span>]    </span></code> 
				 :: <span class="emphasis"><em> If True, performs a preliminary PCA

</em></span></li>
                </ul>
              </div>
            </div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="id3063466"></a>Outputs</h5>
                  </div>
                </div>
              </div>
              <div class="itemizedlist">
                <ul type="disc">
                  <li><code class="varname">eof[0]    </code><code class="option"><span class="ARGspec">[intent:output]    </span></code> 
				 :: <span class="emphasis"><em></em></span></li>
                  <li><code class="varname">pc[0]    </code><code class="option"><span class="ARGspec">[intent:output]    </span></code> 
				 :: <span class="emphasis"><em></em></span></li>
                  <li><code class="varname">eof[1]    </code><code class="option"><span class="ARGspec">[intent:output]    </span></code> 
				 :: <span class="emphasis"><em></em></span></li>
                  <li><code class="varname">pc[1]    </code><code class="option"><span class="ARGspec">[intent:output]    </span></code> 
				 :: <span class="emphasis"><em></em></span></li>
                  <li><code class="varname">ev    </code><code class="option"><span class="ARGspec">[intent:output]    </span></code> 
				 :: <span class="emphasis"><em> Eigen Values  array

        ---blabla---
</em></span></li>
                </ul>
              </div>
            </div>
          </div>
          <div class="sect3" lang="en" xml:lang="en">
            <div class="titlepage">
              <div>
                <div>
                  <h4 class="title"><a id="&lt;SpAn_object&gt;.reconstruct"></a>4.2.9.  Reconstruct results from mssa or pca: <code class="literal">&lt;SpAn_object&gt;.reconstruct</code></h4>
                </div>
              </div>
            </div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="id3064099"></a>Usage</h5>
                  </div>
                </div>
              </div>
              <pre class="programlisting"><span class="HLpersonalised">ffrec</span>[<span class="HLpersonalised">0</span>] = <span class="HLpersonalised">&lt;SpAn_object&gt;.reconstruct</span>(<span class="HLpersonalised">start</span>=<span class="HLpersonalised">1</span>, <span class="HLpersonalised">end</span>=<span class="HLpersonalised">None</span>, <span class="HLpersonalised">mssa</span>=<span class="HLpersonalised">None</span>, <span class="HLpersonalised">pca</span>=<span class="HLpersonalised">None</span>, <span class="HLpersonalised">phases</span>=<span class="HLpersonalised">False</span>, <span class="HLpersonalised">nphases</span>=<span class="HLpersonalised">8</span>, <span class="HLpersonalised">offset</span>=.<span class="HLpersonalised">5</span>, <span class="HLpersonalised">firstphase</span>=<span class="HLpersonalised">0</span>, <span class="HLpersonalised">svd</span>=<span class="HLpersonalised">None</span>)</pre>
            </div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="id3046116"></a>Description</h5>
                  </div>
                </div>
              </div>
              <p>          This function performs recontructions to retreive the
          the contribution of a selection of modes to the original field.
          By default, it recontructs from available PCA and MSSA
          results. Recontruction of MSSA modes also calls recontruction
          from of pre-PCA to get back to the original space.
          This function can optionally performs phase composites
          (useful for pairs of MSSA modes = oscillations) on MSSA
          recontructions.
</p>
            </div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="id3046135"></a>Optional arguments</h5>
                  </div>
                </div>
              </div>
              <div class="itemizedlist">
                <ul type="disc">
                  <li><code class="varname">start    </code><code class="option"><span class="ARGspec">[intent:input, default:<span class="HLpersonalised">1</span>]    </span></code> 
				 :: <span class="emphasis"><em> First mode
</em></span></li>
                  <li><code class="varname">end    </code><code class="option"><span class="ARGspec">[intent:input, default:<span class="HLpersonalised">None</span>]    </span></code> 
				 :: <span class="emphasis"><em> Last mode
</em></span></li>
                  <li><code class="varname">mssa    </code><code class="option"><span class="ARGspec">[intent:input, default:<span class="HLpersonalised">None</span>]    </span></code> 
				 :: <span class="emphasis"><em> Reconstruct MSSA if True
</em></span></li>
                  <li><code class="varname">pca    </code><code class="option"><span class="ARGspec">[intent:input, default:<span class="HLpersonalised">None</span>]    </span></code> 
				 :: <span class="emphasis"><em> Reconstruct PCA if True
</em></span></li>
                  <li><code class="varname">phases    </code><code class="option"><span class="ARGspec">[intent:input, default:<span class="HLpersonalised">False</span>]    </span></code> 
				 :: <span class="emphasis"><em> Operate phase reconstruction True/False (default is False)
</em></span></li>
                  <li><code class="varname">nphases    </code><code class="option"><span class="ARGspec">[intent:input, default:<span class="HLpersonalised">8</span>]    </span></code> 
				 :: <span class="emphasis"><em></em></span></li>
                  <li><code class="varname">offset    </code><code class="option"><span class="ARGspec">[intent:input, default:<span class="HLpersonalised">.5</span>]    </span></code> 
				 :: <span class="emphasis"><em></em></span></li>
                  <li><code class="varname">firstphase    </code><code class="option"><span class="ARGspec">[intent:input, default:<span class="HLpersonalised">0</span>]    </span></code> 
				 :: <span class="emphasis"><em></em></span></li>
                  <li><code class="varname">svd    </code><code class="option"><span class="ARGspec">[intent:input, default:<span class="HLpersonalised">None</span>]    </span></code> 
				 :: <span class="emphasis"><em></em></span></li>
                </ul>
              </div>
            </div>
            <div class="simplesect" lang="en" xml:lang="en">
              <div class="titlepage">
                <div>
                  <div>
                    <h5 class="title"><a id="id3067610"></a>Outputs</h5>
                  </div>
                </div>
              </div>
              <div class="itemizedlist">
                <ul type="disc">
                  <li><code class="varname">ffrec[0]    </code><code class="option"><span class="ARGspec">[intent:output]    </span></code> 
				 :: <span class="emphasis"><em></em></span></li>
                </ul>
              </div>
            </div>
          </div>
        </div>
        <div class="sect2" lang="en" xml:lang="en">
          <div class="titlepage">
            <div>
              <div>
                <h3 class="title"><a id="doc_pyt_exa"></a>4.3. Python examples</h3>
              </div>
            </div>
          </div>
          <p>
				These examples show how to use some of the available
				components of the python module.
				They uses the same dataset as for <a href="#doc_f90_exa" title="3.3.&#xA0;Fortran 90 examples">Section 3.3, “Fortran 90 examples”</a>.
			</p>
          <div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3>
				You can run depending on your configuration, and
				you must have previously performed a <pre class="programlisting"><code class="prompt">&lt;user&gt;</code> <strong class="userinput"><code>make install</code></strong></pre></div>
          <div class="sect3" lang="en" xml:lang="en">
            <div class="titlepage">
              <div>
                <div>
                  <h4 class="title"><a id="doc_pyt_ex1"></a>4.3.1. Python example 1</h4>
                </div>
              </div>
            </div>
            <p>
					This first example is similar to <a href="#doc_f90_exa" title="3.3.&#xA0;Fortran 90 examples">Section 3.3, “Fortran 90 examples”</a>:
					a PCA/MSSA is performed on the whole dataset,
					and the first oscillation (pair of MSSA modes) is
				reconstructed using phases composites (16 phases).
				</p>
            <div class="example">
              <a id="id3020191"></a>
              <p class="title">
                <b>Example 3. Python example 1</b>
              </p>
              <p>
						Run this example using:
						</p>
              <pre class="programlisting"><code class="prompt">&lt;user&gt;</code> <strong class="userinput"><code>make python1</code></strong></pre>
              <p>
							</p>
              <pre class="programlisting"><span class="HLcomments"># File: example2.py</span>
<span class="HLcomments">#</span>
<span class="HLcomments"># This file is part of the SpanLib library.</span>
<span class="HLcomments"># Copyright (C) 2006  Charles Doutiraux, Stephane Raynaud</span>
<span class="HLcomments"># Contact: stephane dot raynaud at gmail dot com</span>
<span class="HLcomments">#</span>
<span class="HLcomments"># This library is free software; you can redistribute it and/or</span>
<span class="HLcomments"># modify it under the terms of the GNU Lesser General Public</span>
<span class="HLcomments"># License as published by the Free Software Foundation; either</span>
<span class="HLcomments"># version 2.1 of the License, or (at your option) any later version.</span>
<span class="HLcomments">#</span>
<span class="HLcomments"># This library is distributed in the hope that it will be useful,</span>
<span class="HLcomments"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="HLcomments"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="HLcomments"># Lesser General Public License for more details.</span>
<span class="HLcomments">#</span>
<span class="HLcomments"># You should have received a copy of the GNU Lesser General Public</span>
<span class="HLcomments"># License along with this library; if not, write to the Free Software</span>
<span class="HLcomments"># Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA</span>


<span class="HLcomments">###################################################################</span>
<span class="HLcomments"># In this example, we analyse two different areas at the same time.</span>
<span class="HLcomments"># You can do the same with two completely different datasets,</span>
<span class="HLcomments"># except that they must have the same temporal grid.</span>
<span class="HLcomments">###################################################################</span>
<span class="HLcommands">print</span> "<span class="HLcomments">##############################################"</span>
<span class="HLcommands">print</span> "<span class="HLcomments"># PCA+MSSA applied on two different regions. #"</span>
<span class="HLcommands">print</span> "<span class="HLcomments"># Then reconstructions and plots.            #"</span>
<span class="HLcommands">print</span> "<span class="HLcomments">##############################################"</span>

<span class="HLcomments"># Needed modules</span>
<span class="HLcommands">import</span> cdms
<span class="HLcommands">import</span> spanlib
<span class="HLcommands">import</span> MV
<span class="HLcommands">import</span> vcs

<span class="HLcomments"># We tell cdms that we have longitude, latitude and time</span>
cdms.axis.latitude_aliases.append(<span class="HLstrings">'Y'</span>)
cdms.axis.longitude_aliases.append(<span class="HLstrings">'X'</span>)
cdms.axis.time_aliases.append(<span class="HLstrings">'T'</span>)

<span class="HLcomments"># Simply open the netcdf file</span>
<span class="HLcommands">print</span> <span class="HLstrings">"<span class="HLfunctions">Open</span> file"</span>
f=cdms.<span class="HLfunctions">open</span>(<span class="HLstrings">'data2.cdf'</span>)

<span class="HLcomments"># Get our two datasets</span>
<span class="HLcommands">print</span> <span class="HLstrings">"Read two different regions"</span>
s2=f(<span class="HLstrings">'ssta'</span>,latitude=(-<span class="HLdigits">10</span>,<span class="HLdigits">10</span>),longitude=(<span class="HLdigits">110</span>,<span class="HLdigits">180</span>))
s1=f(<span class="HLstrings">'ssta'</span>,latitude=(-<span class="HLdigits">15</span>,<span class="HLdigits">15</span>),longitude=(<span class="HLdigits">210</span>,<span class="HLdigits">250</span>))

<span class="HLcomments"># Stack the two dataset to have only one dataset</span>
<span class="HLcommands">print</span> <span class="HLstrings">"Stacking data"</span>
res = spanlib.<span class="HLpersonalised">stackData</span>(s1,s2)

<span class="HLcomments"># Create the analysis object</span>
<span class="HLcommands">print</span> <span class="HLstrings">"Creating <span class="HLpersonalised">SpAn</span> object"</span>
SP=spanlib.<span class="HLpersonalised">SpAn</span>(MV.array(res[<span class="HLdigits">0</span>]),weights=MV.array(res[<span class="HLdigits">1</span>]))

<span class="HLcomments"># Perform a preliminary PCA</span>
<span class="HLcomments"># (optional step since done by default with mssa)</span>
<span class="HLcommands">print</span> <span class="HLstrings">"<span class="HLpersonalised">PCA</span>+<span class="HLpersonalised">MSSA</span>..."</span>
steof,stpc,stev = SP.<span class="HLpersonalised">mssa</span>(<span class="HLpersonalised">pca</span>=<span class="HLspecial">True</span>)

<span class="HLcomments"># Recontructed the filtered field</span>
<span class="HLcommands">print</span> <span class="HLstrings">"Reconstructing selected modes"</span>
ffrec = SP.<span class="HLpersonalised">reconstruct</span>()

<span class="HLcomments"># Unstacking</span>
<span class="HLcommands">print</span> <span class="HLstrings">"Unstaking data"</span>
out = spanlib.<span class="HLpersonalised">unStackData</span>(ffrec,res[<span class="HLdigits">1</span>],res[<span class="HLdigits">2</span>],res[<span class="HLdigits">3</span>])

<span class="HLcomments"># Plot a timeseries taken from our two</span>
<span class="HLcomments"># recontructed datasets</span>
<span class="HLcommands">print</span> <span class="HLstrings">"Time series <span class="HLcommands">for</span> the two filtered regions"</span>
x=vcs.init()
x.plot(out[<span class="HLdigits">1</span>][:,<span class="HLdigits">5</span>,<span class="HLdigits">5</span>])
x.plot(out[<span class="HLdigits">0</span>][:,<span class="HLdigits">5</span>,<span class="HLdigits">5</span>])
<span class="HLfunctions">raw_input</span>(<span class="HLstrings">'ok?'</span>)
</pre>
            </div>
          </div>
          <div class="sect3" lang="en" xml:lang="en">
            <div class="titlepage">
              <div>
                <div>
                  <h4 class="title"><a id="doc_pyt_ex2"></a>4.3.2. Python example 2</h4>
                </div>
              </div>
            </div>
            <p>
					In this second example, two different areas are analysed at
					the same time.
					This is intented to mimics the used of two different datasets
					that are stacked, before being analysed.
					Such approach (see for example <a href="#raynal06">Raynaud et al (2006)</a>) allows
					to find modes of variability in a arbitrary number of variables,
					provided you are careful with units (performing appropriate normalisations).
				</p>
          </div>
          <div class="example">
            <a id="id3020248"></a>
            <p class="title">
              <b>Example 4. Python example 2</b>
            </p>
            <p>
					Run this example using:
					</p>
            <pre class="programlisting"><code class="prompt">&lt;user&gt;</code> <strong class="userinput"><code>make python2</code></strong></pre>
            <p>
				</p>
            <pre class="programlisting"></pre>
          </div>
        </div>
      </div>
      <div class="sect1" lang="en" xml:lang="en">
        <div class="titlepage">
          <div>
            <div>
              <h2 class="title" style="clear: both"><a id="doc_lin"></a>5. Links</h2>
            </div>
          </div>
        </div>
        <div class="itemizedlist">
          <ul type="disc">
            <li>
				Home page of the project:
				<a href="http://spanlib.sourceforge.net" target="_top">http://spanlib.sourceforge.net</a></li>
            <li>
				Sourceforge page of the project where you can find news, forums,
				where to report bugs, where to request features, files to download, etc:
				<a href="http://sourceforge.net/projects/spanlib/" target="_top">http://sourceforge.net/projects/spanlib/</a></li>
            <li>
				An example of use of MSSA is available
				at <a href="http://stefdeperou.free.fr/meteo.php" target="_top">http://stefdeperou.free.fr/meteo.php</a> (french).
				This example shows an analysis of air temperatures at Orly airport,
				with different values of parameters.
				It also provides an example of prediction using the analysis results.
			</li>
            <li><a id="ssa-mtm"></a>
				The <a href="http://www.atmos.ucla.edu/tcd/ssa/" target="_top">SSA-MTM Toolkit </a>
				is graphical interface to PCA, MSSA and other methods.
				It is useful to make comparisons of methods.
				This website provides a lot of exlplanations of how these analysis methods works.
			</li>
          </ul>
        </div>
      </div>
      <div class="bibliography">
        <div class="titlepage">
          <div>
            <div>
              <h2 class="title"><a id="doc_bib"></a>Bibliography</h2>
            </div>
          </div>
        </div>
        <div class="biblioentry">
          <a id="prei88"></a>
          <p>[<span class="abbrev">1</span>] <span class="authorgroup"><span class="firstname">R.</span> <span class="surname">Preisendorfer</span>. </span><span class="citetitle">“<span class="citetitle">Principal Component Analysis in Meteorology and Oceanography</span>”. </span><span class="publisher"><span class="publishername">Elsevier Sci.. </span></span><span class="pubdate">1988. </span></p>
        </div>
        <div class="biblioentry">
          <a id="wilk95"></a>
          <p>[<span class="abbrev">2</span>] <span class="authorgroup"><span class="firstname">D.</span> <span class="surname">Wilks</span>. </span><span class="citetitle">“<span class="citetitle">Statistical methods in the atmospheric sciences</span>”. </span><span class="publisher"><span class="publishername">Cornell University. </span></span><span class="pubdate">1995. </span></p>
        </div>
        <div class="biblioentry">
          <a id="brki86"></a>
          <p>[<span class="abbrev">3</span>] <span class="authorgroup"><span class="firstname">S.</span> <span class="othername">D.</span> <span class="surname">Broomhead</span> and <span class="firstname">G.</span> <span class="othername">P.</span> <span class="surname">King</span>. </span><span class="citetitle">“<span class="citetitle">Extracting qualitative dynamics from experimental data</span>”. </span><span class="citetitle"><em class="citetitle">Physica D</em>. </span><span class="publisher"><span class="publishername">Elsevier Science Publishers B. V.. </span></span><span class="volumenum">20. </span><span class="artpagenums">217–236. </span><span class="pubdate">1986. </span></p>
        </div>
        <div class="biblioentry">
          <a id="vagh89"></a>
          <p>[<span class="abbrev">4</span>] <span class="authorgroup"><span class="firstname">R.</span> <span class="surname">Vautard</span> and <span class="firstname">M.</span> <span class="surname">Ghil</span>. </span><span class="citetitle">“<span class="citetitle">Singular Spectrum Analysis in nonlinear dynamics,with application to paleoclimatic time series</span>”. </span><span class="citetitle"><em class="citetitle">Physica D</em>. </span><span class="volumenum">35. </span><span class="artpagenums">395-424. </span><span class="pubdate">1989. </span></p>
        </div>
        <div class="biblioentry">
          <a id="plva94"></a>
          <p>[<span class="abbrev">5</span>] <span class="authorgroup"><span class="firstname">G.</span> <span class="surname">Plaut</span> and <span class="firstname">R.</span> <span class="surname">Vautard</span>. </span><span class="citetitle">“<span class="citetitle"> Spells of low-frequency oscillations and weather regimes in the northern hemisphere</span>”. </span><span class="citetitle"><em class="citetitle">J. Atm. Sc.</em>. </span><span class="volumenum">51. </span><span class="artpagenums">210-236. </span><span class="pubdate">1994. </span></p>
        </div>
        <div class="biblioentry">
          <a id="raynal05"></a>
          <p>[<span class="abbrev">6</span>] <span class="authorgroup"><span class="firstname">S.</span> <span class="surname">Raynaud</span>, <span class="firstname">P.</span> <span class="surname">Yiou</span>, <span class="firstname">R.</span> <span class="surname">Kleeman</span>, and <span class="firstname">S.</span> <span class="surname">Speich</span>. </span><span class="citetitle">“<span class="citetitle">Using MSSA to determine explicitly the oscillatory dynamics of weakly nonlinear climate systems</span>”. </span><span class="citetitle"><em class="citetitle">Nonlin. Proc. Geophys.</em>. </span><span class="volumenum">12. </span><span class="artpagenums">807–815. </span><span class="pubdate">2005. </span><span class="releaseinfo"><a href="http://www.nonlin-processes-geophys.net/12/807/2005/npg-12-807-2005.pdf" target="_top">Download</a>. </span></p>
        </div>
        <div class="biblioentry">
          <a id="raynal06"></a>
          <p>[<span class="abbrev">7</span>] <span class="authorgroup"><span class="firstname">S.</span> <span class="surname">Raynaud</span>, <span class="firstname">O.</span> <span class="surname">Aumont</span>, <span class="firstname">K.</span> <span class="surname">Rodgers</span>, and <span class="firstname">P.</span> <span class="surname">Yiou</span>. </span><span class="citetitle">“<span class="citetitle">Interannual to decadal variability of air-sea CO2 fluxes in the North Atlantic</span>”. </span><span class="citetitle"><em class="citetitle">Ocean Sci.</em>. </span><span class="volumenum">2. </span><span class="artpagenums">43-60. </span><span class="pubdate">2006. </span><span class="releaseinfo"><a href="http://www.ocean-sci.net/2/43/2006/os-2-43-2006.pdf" target="_top">Download</a>. </span></p>
        </div>
      </div>
    </div>
  </body>
</html>
