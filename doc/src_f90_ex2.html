<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>SpanLib - Fortran 90 example 2</title><link rel="stylesheet" href="spanlib.css" type="text/css" /><meta name="generator" content="DocBook XSL Stylesheets V1.61.2" /></head><body><div class="article" lang="en" xml:lang="en"><div class="titlepage"><div><div><h1 class="title"><a id="id2956207"></a>SpanLib - Fortran 90 example 2</h1></div></div><div></div><hr /></div><pre class="programlisting"><span class="HLcomments">! File: example2.f90</span>
<span class="HLcomments">!</span>
<span class="HLcomments">! This file is part of the SpanLib library.</span>
<span class="HLcomments">! Copyright (C) 2006  Stephane Raynaud</span>
<span class="HLcomments">! Contact: stephane dot raynaud at gmail dot com</span>
<span class="HLcomments">!</span>
<span class="HLcomments">! This library is free software; you can redistribute it and/or</span>
<span class="HLcomments">! modify it under the terms of the GNU Lesser General Public</span>
<span class="HLcomments">! License as published by the Free Software Foundation; either</span>
<span class="HLcomments">! version 2.1 of the License, or (at your option) any later version.</span>
<span class="HLcomments">!</span>
<span class="HLcomments">! This library is distributed in the hope that it will be useful,</span>
<span class="HLcomments">! but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="HLcomments">! MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="HLcomments">! Lesser General Public License for more details.</span>
<span class="HLcomments">!</span>
<span class="HLcomments">! You should have received a copy of the GNU Lesser General Public</span>
<span class="HLcomments">! License along with this library; if not, write to the Free Software</span>
<span class="HLcomments">! Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA</span>

<span class="HLroutines">program</span> example2

	<span class="HLcomments">! This simple example shows how to use PCA and SVD from this package.</span>
	<span class="HLcomments">! Warning: it requires netcdf for in/outputs.</span>
	<span class="HLcomments">!</span>
	<span class="HLcomments">! This example works in a very similar way to the first fortran example,</span>
	<span class="HLcomments">! with the same initial dataset.</span>
	<span class="HLcomments">!</span>
	<span class="HLcomments">! To mimics the use of two different datasets, two geographical</span>
	<span class="HLcomments">! regions are decomposed using SVD. As for MSSA, a pre-PCA is</span>
	<span class="HLcomments">! performed (independantly for the two regions).</span>
	<span class="HLcomments">! One region is situated in the east of the basin, the other</span>
	<span class="HLcomments">! one is on the west.</span>
	<span class="HLcomments">! The dominant EOFs from the SVD decomposition are reconstructed</span>
	<span class="HLcomments">! back to the physical space and stored in the output netcdf file</span>
	<span class="HLcomments">! along with their PCs.</span>
	<span class="HLcomments">!</span>
	<span class="HLcomments">! Note:</span>
	<span class="HLcomments">!	This example should run only a few seconds.</span>
	<span class="HLcomments">!	If it is not the case, your BLAS/LAPACK librairy is not optimized.</span>


	<span class="HLroutines">use</span> spanlib
	<span class="HLroutines">use</span> netcdf

	<span class="HLroutines">implicit</span> <span class="HLattributes">none</span>

	<span class="HLcomments">! Parameters</span>
	<span class="HLcomments">! ----------</span>
	<span class="HLroutines">integer</span>,<span class="HLattributes">parameter</span> :: pcaNkeep=<span class="HLdigits">10</span>, svdNkeep=<span class="HLdigits">5</span>,&amp;
		&amp; lons1(<span class="HLdigits">2</span>)=(/<span class="HLdigits">70</span>,<span class="HLdigits">150</span>/),lats1(<span class="HLdigits">2</span>)=(/<span class="HLdigits">16</span>,<span class="HLdigits">45</span>/),&amp; <span class="HLcomments">! East</span>
		&amp; lons2(<span class="HLdigits">2</span>)=(/<span class="HLdigits">10</span>,<span class="HLdigits">40</span>/),lats2(<span class="HLdigits">2</span>)=(/<span class="HLdigits">12</span>,<span class="HLdigits">49</span>/)    <span class="HLcomments">! West</span>
	<span class="HLroutines">real</span>, <span class="HLattributes">parameter</span> ::new_missing_value=-<span class="HLdigits">999</span>.
	<span class="HLroutines">character</span>(len=<span class="HLdigits">20</span>), <span class="HLattributes">parameter</span> :: input_nc_file=<span class="HLstrings">&quot;data2.cdf&quot;</span>, &amp;
		&amp; output_nc_file=<span class="HLstrings">&quot;output2.nc&quot;</span>, var_name=<span class="HLstrings">'ssta'</span>

	<span class="HLcomments">! Other declarations</span>
	<span class="HLcomments">! ------------------</span>
	<span class="HLroutines">real</span>, <span class="HLattributes">allocatable</span> :: lon1(:), lat1(:), &amp;
		&amp; lon2(:), lat2(:), time(:), &amp;
		&amp; sst1(:,:,:), sst2(:,:,:), sst(:,:,:)
	<span class="HLroutines">logical</span>, <span class="HLattributes">allocatable</span> :: mask(:,:),mask1(:,:),mask2(:,:)
	<span class="HLroutines">real</span>, <span class="HLattributes">allocatable</span> :: packed_sst1(:,:),packed_sst2(:,:)
	<span class="HLroutines">real</span>, <span class="HLattributes">allocatable</span> :: svdEv(:), &amp;
		&amp; pcaEofs1(:,:),pcaEofs2(:,:),pcaPcs1(:,:),pcaPcs2(:,:), &amp;
		&amp; svdEofs1(:,:),svdEofs2(:,:),svdPcs1(:,:),svdPcs2(:,:), &amp;
		&amp; svdEofsRec1(:,:,:), svdEofsRec2(:,:,:), &amp;
		&amp; packed_svdEofsRec1(:,:), packed_svdEofsRec2(:,:)
	<span class="HLroutines">character</span>(len=<span class="HLdigits">20</span>) :: dim_names(<span class="HLdigits">3</span>), dim_name, &amp;
		&amp; lon_units, lat_units, var_units, &amp;
		&amp;	lon_name, lat_name, time_name, time_units
	<span class="HLroutines">integer</span> :: ncid, dimid, dimids(<span class="HLdigits">6</span>), varids(<span class="HLdigits">6</span>), sstids(<span class="HLdigits">7</span>), &amp;
		&amp; dims(<span class="HLdigits">3</span>), thisdim, &amp;
		&amp; lonid, latid, phaseid, timeid, phcoid, recoid, origid
	<span class="HLroutines">integer</span>(kind=<span class="HLdigits">4</span>) :: i,nspace,nlon1,nlat1,nlon2,nlat2,ntime,ns1,ns2
	<span class="HLroutines">real</span> :: missing_value

	<span class="HLcomments">! Get the initial sst field from the netcdf file</span>
	<span class="HLcomments">! ----------------------------------------------</span>
	<span class="HLroutines">print</span>*,<span class="HLstrings">'Reading inputs...'</span>
	<span class="HLroutines">call</span> err(nf90_open(input_nc_file, nf90_nowrite, ncid))
	<span class="HLroutines">call</span> err(nf90_inq_varid(ncid, var_name, sstids(<span class="HLdigits">1</span>)))
	<span class="HLcomments">! Dimensions</span>
	nlon1 = lons1(<span class="HLdigits">2</span>)-lons1(<span class="HLdigits">1</span>)+<span class="HLdigits">1</span> ;	nlat1 = lats1(<span class="HLdigits">2</span>)-lats1(<span class="HLdigits">1</span>)+<span class="HLdigits">1</span>
	nlon2 = lons2(<span class="HLdigits">2</span>)-lons2(<span class="HLdigits">1</span>)+<span class="HLdigits">1</span> ; nlat2 = lats2(<span class="HLdigits">2</span>)-lats2(<span class="HLdigits">1</span>)+<span class="HLdigits">1</span>
	<span class="HLroutines">call</span> err(nf90_inquire_variable(ncid, sstids(<span class="HLdigits">1</span>), dimids=dimids(<span class="HLdigits">1</span>:<span class="HLdigits">3</span>)))
	<span class="HLroutines">call</span> err(nf90_inquire_dimension(ncid,dimids(<span class="HLdigits">1</span>),name=lon_name))
	<span class="HLroutines">call</span> err(nf90_inquire_dimension(ncid,dimids(<span class="HLdigits">2</span>),name=lat_name))
	<span class="HLroutines">call</span> err(nf90_inquire_dimension(ncid, dimids(<span class="HLdigits">3</span>), &amp;
		&amp;	name=time_name, len=ntime))
	<span class="HLcomments">! Allocations</span>
	<span class="HLfunctions">allocate</span>(sst1(nlon1,nlat1,ntime),sst2(nlon2,nlat2,ntime))
	<span class="HLfunctions">allocate</span>(mask1(nlon1,nlat1),mask2(nlon2,nlat2))
	<span class="HLfunctions">allocate</span>(lon1(nlon1),lat1(nlat1))
	<span class="HLfunctions">allocate</span>(lon2(nlon2),lat2(nlat2))
	<span class="HLfunctions">allocate</span>(time(ntime))
	<span class="HLcomments">! SST boxes and attributes</span>
	<span class="HLroutines">call</span> err(nf90_get_var(ncid, sstids(<span class="HLdigits">1</span>), sst1,&amp;
		&amp; start=(/lons1(<span class="HLdigits">1</span>),lats1(<span class="HLdigits">1</span>),<span class="HLdigits">1</span>/), &amp;
		&amp; count=(/lons1(<span class="HLdigits">2</span>)-lons1(<span class="HLdigits">1</span>)+<span class="HLdigits">1</span>,lats1(<span class="HLdigits">2</span>)-lats1(<span class="HLdigits">1</span>)+<span class="HLdigits">1</span>,ntime/)))
	<span class="HLroutines">call</span> err(nf90_get_var(ncid, sstids(<span class="HLdigits">1</span>), sst2,&amp;
		&amp; start=(/lons2(<span class="HLdigits">1</span>),lats2(<span class="HLdigits">1</span>),<span class="HLdigits">1</span>/), &amp;
		&amp; count=(/lons2(<span class="HLdigits">2</span>)-lons2(<span class="HLdigits">1</span>)+<span class="HLdigits">1</span>,lats2(<span class="HLdigits">2</span>)-lats2(<span class="HLdigits">1</span>)+<span class="HLdigits">1</span>,ntime/)))
	<span class="HLroutines">call</span> err(nf90_get_att(ncid,sstids(<span class="HLdigits">1</span>),<span class="HLstrings">'missing_value'</span>,missing_value))
	<span class="HLroutines">call</span> err(nf90_get_att(ncid,sstids(<span class="HLdigits">1</span>),<span class="HLstrings">'units'</span>,var_units))
	<span class="HLcomments">! Longitudes</span>
	<span class="HLroutines">call</span> err(nf90_inq_varid(ncid, lon_name, varids(<span class="HLdigits">1</span>)))
	<span class="HLroutines">call</span> err(nf90_get_var(ncid, varids(<span class="HLdigits">1</span>), lon1, &amp;
		&amp; start=(/lons1(<span class="HLdigits">1</span>)/), count=(/lons1(<span class="HLdigits">2</span>)-lons1(<span class="HLdigits">1</span>)+<span class="HLdigits">1</span>/)))
	<span class="HLroutines">call</span> err(nf90_get_att(ncid, varids(<span class="HLdigits">1</span>), <span class="HLstrings">'units'</span>, lon_units))
	<span class="HLroutines">call</span> err(nf90_get_var(ncid, varids(<span class="HLdigits">1</span>), lon2, &amp;
		&amp; start=(/lons2(<span class="HLdigits">1</span>)/), count=(/lons2(<span class="HLdigits">2</span>)-lons2(<span class="HLdigits">1</span>)+<span class="HLdigits">1</span>/)))
	<span class="HLcomments">! Latitudes</span>
	<span class="HLroutines">call</span> err(nf90_inq_varid(ncid, lat_name, varids(<span class="HLdigits">1</span>)))
	<span class="HLroutines">call</span> err(nf90_get_var(ncid, varids(<span class="HLdigits">1</span>), lat1, &amp;
		&amp; start=(/lats1(<span class="HLdigits">1</span>)/), count=(/lats1(<span class="HLdigits">2</span>)-lats1(<span class="HLdigits">1</span>)+<span class="HLdigits">1</span>/)))
	<span class="HLroutines">call</span> err(nf90_get_att(ncid, varids(<span class="HLdigits">1</span>), <span class="HLstrings">'units'</span>, lat_units))
	<span class="HLroutines">call</span> err(nf90_get_var(ncid, varids(<span class="HLdigits">1</span>), lat2, &amp;
		&amp; start=(/lats2(<span class="HLdigits">1</span>)/), count=(/lats2(<span class="HLdigits">2</span>)-lats2(<span class="HLdigits">1</span>)+<span class="HLdigits">1</span>/)))
	<span class="HLcomments">! Time</span>
	<span class="HLroutines">call</span> err(nf90_inq_varid(ncid, time_name, varids(<span class="HLdigits">1</span>)))
	<span class="HLroutines">call</span> err(nf90_get_var(ncid, varids(<span class="HLdigits">1</span>), time))
	<span class="HLroutines">call</span> err(nf90_get_att(ncid, varids(<span class="HLdigits">1</span>), <span class="HLstrings">'units'</span>, time_units))
	<span class="HLroutines">call</span> err(nf90_close(ncid))


	<span class="HLcomments">! Format (pack) data to have only one space dimension</span>
	<span class="HLcomments">! ---------------------------------------------------</span>
	<span class="HLroutines">print</span>*,<span class="HLstrings">'Packing...'</span>

	<span class="HLcomments">! Now pack</span>
	mask1 = (sst1(:,:,<span class="HLdigits">1</span>) /= missing_value)
	mask2 = (sst2(:,:,<span class="HLdigits">1</span>) /= missing_value)
	ns1 = count(mask1) ; ns2 = count(mask2)
	<span class="HLfunctions">allocate</span>(packed_sst1(ns1, ntime))
	<span class="HLfunctions">allocate</span>(packed_sst2(ns2, ntime))
	<span class="HLroutines">do</span> i=<span class="HLdigits">1</span>, ntime
		packed_sst1(:,i) = <span class="HLfunctions">pack</span>(sst1(:,:,i), mask1)
		packed_sst2(:,i) = <span class="HLfunctions">pack</span>(sst2(:,:,i), mask2)
	<span class="HLroutines">end</span> <span class="HLroutines">do</span>
	where(sst1==missing_value)sst1 = new_missing_value
	where(sst2==missing_value)sst2 = new_missing_value

	<span class="HLcomments">! Perform a PCA to reduce the d.o.f</span>
	<span class="HLcomments">! ---------------------------------</span>
	<span class="HLroutines">print</span>*,<span class="HLstrings">'[<span class="HLpersonalised">sl_pca</span>] Pre-PCA ...'</span>
	<span class="HLfunctions">allocate</span>(pcaEofs1(ns1, pcaNkeep))
	<span class="HLfunctions">allocate</span>(pcaPcs1(ntime,pcaNkeep))
	<span class="HLroutines">call</span> <span class="HLpersonalised">sl_pca</span>(packed_sst1, pcaNkeep, xeof=pcaEofs1, pc=pcaPcs1)
	<span class="HLfunctions">allocate</span>(pcaEofs2(ns2, pcaNkeep))
	<span class="HLfunctions">allocate</span>(pcaPcs2(ntime,pcaNkeep))
	<span class="HLroutines">call</span> <span class="HLpersonalised">sl_pca</span>(packed_sst2, pcaNkeep, xeof=pcaEofs2, pc=pcaPcs2)
	<span class="HLfunctions">deallocate</span>(packed_sst1,packed_sst2)


	<span class="HLcomments">! Perform a SVD on previous PCs</span>
	<span class="HLcomments">! -----------------------------</span>
	<span class="HLroutines">print</span>*,<span class="HLstrings">'[<span class="HLpersonalised">sl_svd</span>] SVD...'</span>
	<span class="HLfunctions">allocate</span>(svdEofs1(pcaNkeep,svdNkeep),svdPcs1(ntime,svdNkeep))
	<span class="HLfunctions">allocate</span>(svdEofs2(pcaNkeep,svdNkeep),svdPcs2(ntime,svdNkeep))
	<span class="HLfunctions">allocate</span>(svdEv(svdNkeep))
	<span class="HLroutines">call</span> <span class="HLpersonalised">sl_svd</span>(<span class="HLfunctions">transpose</span>(pcaPcs1),<span class="HLfunctions">transpose</span>(pcaPcs2),&amp;
		&amp; svdNkeep,leof=svdEofs1,reof=svdEofs2,&amp;
		&amp; lpc=svdPcs1,rpc=svdPcs2,ev=svdEv)
	<span class="HLfunctions">deallocate</span>(pcaPcs1,pcaPcs2)

	<span class="HLcomments">! Swicth SVD EOFs to the physical space (!)</span>
	<span class="HLcomments">! -----------------------------------------</span>
	<span class="HLroutines">print</span>*,<span class="HLstrings">'[sl_pcarec] Back to the physical space ...'</span>
	<span class="HLfunctions">allocate</span>(packed_svdEofsRec1(ns1,svdNkeep))
	<span class="HLfunctions">allocate</span>(packed_svdEofsRec2(ns2,svdNkeep))
	<span class="HLroutines">call</span> sl_pcarec(pcaEofs1, <span class="HLfunctions">transpose</span>(svdEofs1), packed_svdEofsRec1)
	<span class="HLroutines">call</span> sl_pcarec(pcaEofs2, <span class="HLfunctions">transpose</span>(svdEofs2), packed_svdEofsRec2)
	<span class="HLfunctions">deallocate</span>(pcaEofs1,svdEofs1,pcaEofs2,svdEofs2)

	<span class="HLcomments">! Unpacking</span>
	<span class="HLcomments">! ---------</span>
	<span class="HLroutines">print</span>*,<span class="HLstrings">'Unpacking...'</span>
	<span class="HLfunctions">allocate</span>(svdEofsRec1(nlon1,nlat1,svdNkeep))
	<span class="HLfunctions">allocate</span>(svdEofsRec2(nlon2,nlat2,svdNkeep))
	<span class="HLroutines">do</span> i=<span class="HLdigits">1</span>, svdNkeep
		svdEofsRec1(:,:,i) = <span class="HLfunctions">unpack</span>(packed_svdEofsRec1(:,i), &amp;
			&amp; mask1, new_missing_value)
		svdEofsRec2(:,:,i) = <span class="HLfunctions">unpack</span>(packed_svdEofsRec2(:,i), &amp;
			&amp; mask2, new_missing_value)
		where(.<span class="HLfunctions">not</span>.mask1)svdEofsRec1(:,:,i) = new_missing_value
		where(.<span class="HLfunctions">not</span>.mask2)svdEofsRec2(:,:,i) = new_missing_value
	<span class="HLroutines">end</span> <span class="HLroutines">do</span>


	<span class="HLcomments">! Write out the phase composites of the first oscillation</span>
	<span class="HLcomments">! -------------------------------------------------------</span>
	<span class="HLroutines">print</span>*,<span class="HLstrings">'Writing out...'</span>
	<span class="HLcomments">! File</span>
	<span class="HLroutines">call</span> err(nf90_create(output_nc_file, nf90_write, ncid))
	<span class="HLcomments">! Dimensions</span>
	<span class="HLroutines">call</span> err(nf90_def_dim(ncid, <span class="HLstrings">'lon1'</span>, nlon1, dimids(<span class="HLdigits">1</span>)))
	<span class="HLroutines">call</span> err(nf90_def_dim(ncid, <span class="HLstrings">'lat1'</span>, nlat1, dimids(<span class="HLdigits">2</span>)))
	<span class="HLroutines">call</span> err(nf90_def_dim(ncid, <span class="HLstrings">'lon2'</span>, nlon2, dimids(<span class="HLdigits">3</span>)))
	<span class="HLroutines">call</span> err(nf90_def_dim(ncid, <span class="HLstrings">'lat2'</span>, nlat2, dimids(<span class="HLdigits">4</span>)))
	<span class="HLroutines">call</span> err(nf90_def_dim(ncid, <span class="HLstrings">'time'</span>, ntime, dimids(<span class="HLdigits">5</span>)))
	<span class="HLroutines">call</span> err(nf90_def_dim(ncid, <span class="HLstrings">'mode'</span>, svdNkeep, dimids(<span class="HLdigits">6</span>)))

	<span class="HLcomments">! Box 1</span>
	<span class="HLroutines">call</span> err(nf90_def_var(ncid, <span class="HLstrings">'lon1'</span>, nf90_float, dimids(<span class="HLdigits">1</span>), &amp;
		&amp; varids(<span class="HLdigits">1</span>)))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, varids(<span class="HLdigits">1</span>), <span class="HLstrings">'long_name'</span>, &amp;
		&amp; <span class="HLstrings">'Longitude'</span>))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, varids(<span class="HLdigits">1</span>), <span class="HLstrings">'units'</span>, lon_units))
	<span class="HLroutines">call</span> err(nf90_def_var(ncid, <span class="HLstrings">'lat1'</span>, nf90_float, dimids(<span class="HLdigits">2</span>), &amp;
		&amp; varids(<span class="HLdigits">2</span>)))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, varids(<span class="HLdigits">2</span>), <span class="HLstrings">'long_name'</span>, &amp;
		&amp; <span class="HLstrings">'Latitude'</span>))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, varids(<span class="HLdigits">2</span>), <span class="HLstrings">'units'</span>, lat_units))
	<span class="HLcomments">! Box 2</span>
	<span class="HLroutines">call</span> err(nf90_def_var(ncid, <span class="HLstrings">'lon2'</span>, nf90_float, dimids(<span class="HLdigits">3</span>), &amp;
		&amp; varids(<span class="HLdigits">3</span>)))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, varids(<span class="HLdigits">3</span>), <span class="HLstrings">'long_name'</span>, &amp;
		&amp; <span class="HLstrings">'Longitude'</span>))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, varids(<span class="HLdigits">3</span>), <span class="HLstrings">'units'</span>, lon_units))
	<span class="HLroutines">call</span> err(nf90_def_var(ncid, <span class="HLstrings">'lat2'</span>, nf90_float, dimids(<span class="HLdigits">4</span>), &amp;
		&amp; varids(<span class="HLdigits">4</span>)))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, varids(<span class="HLdigits">4</span>), <span class="HLstrings">'long_name'</span>, &amp;
		&amp; <span class="HLstrings">'Latitude'</span>))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, varids(<span class="HLdigits">4</span>), <span class="HLstrings">'units'</span>, lat_units))
	<span class="HLcomments">! Time</span>
	<span class="HLroutines">call</span> err(nf90_def_var(ncid, <span class="HLstrings">'time'</span>, nf90_float, dimids(<span class="HLdigits">5</span>), &amp;
		&amp; varids(<span class="HLdigits">5</span>)))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, varids(<span class="HLdigits">5</span>), <span class="HLstrings">'long_name'</span>, <span class="HLstrings">'Time'</span>))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, varids(<span class="HLdigits">5</span>), <span class="HLstrings">'units'</span>, time_units))
	<span class="HLcomments">! Mode</span>
	<span class="HLroutines">call</span> err(nf90_def_var(ncid, <span class="HLstrings">'mode'</span>, nf90_float, dimids(<span class="HLdigits">6</span>), &amp;
		&amp; varids(<span class="HLdigits">6</span>)))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, varids(<span class="HLdigits">6</span>), <span class="HLstrings">'long_name'</span>, <span class="HLstrings">'Mode'</span>))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, varids(<span class="HLdigits">6</span>), <span class="HLstrings">'units'</span>, <span class="HLstrings">'level'</span>))
	<span class="HLcomments">! Original fields</span>
	<span class="HLcomments">! * box1</span>
	<span class="HLroutines">call</span> err(nf90_def_var(ncid, <span class="HLstrings">'sst1'</span>, nf90_float, &amp;
		&amp; (/dimids(<span class="HLdigits">1</span>),dimids(<span class="HLdigits">2</span>),dimids(<span class="HLdigits">5</span>)/), sstids(<span class="HLdigits">1</span>)))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, sstids(<span class="HLdigits">1</span>), <span class="HLstrings">'long_name'</span>, &amp;
		&amp; <span class="HLstrings">'SST anomaly / original field / box <span class="HLdigits">1</span>'</span>))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, sstids(<span class="HLdigits">1</span>), <span class="HLstrings">'units'</span>, var_units))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, sstids(<span class="HLdigits">1</span>), <span class="HLstrings">'missing_value'</span>, &amp;
		&amp; new_missing_value))
	<span class="HLcomments">! * box2</span>
	<span class="HLroutines">call</span> err(nf90_def_var(ncid, <span class="HLstrings">'sst2'</span>, nf90_float, &amp;
	 &amp; (/dimids(<span class="HLdigits">3</span>),dimids(<span class="HLdigits">4</span>),dimids(<span class="HLdigits">5</span>)/), sstids(<span class="HLdigits">2</span>)))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, sstids(<span class="HLdigits">2</span>), <span class="HLstrings">'long_name'</span>, &amp;
		&amp; <span class="HLstrings">'SST anomaly / original field / box <span class="HLdigits">2</span>'</span>))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, sstids(<span class="HLdigits">2</span>), <span class="HLstrings">'units'</span>, var_units))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, sstids(<span class="HLdigits">2</span>), <span class="HLstrings">'missing_value'</span>, &amp;
		&amp; new_missing_value))
	<span class="HLcomments">! SVD EOFs</span>
	<span class="HLcomments">! * box1</span>
	<span class="HLroutines">call</span> err(nf90_def_var(ncid, <span class="HLstrings">'eofs1'</span>, nf90_float, &amp;
	 &amp; (/dimids(<span class="HLdigits">1</span>),dimids(<span class="HLdigits">2</span>),dimids(<span class="HLdigits">6</span>)/),sstids(<span class="HLdigits">3</span>)))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, sstids(<span class="HLdigits">3</span>), <span class="HLstrings">'long_name'</span>, &amp;
		&amp; <span class="HLstrings">'SVD EOFs of SST anomaly / box <span class="HLdigits">1</span>'</span>))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, sstids(<span class="HLdigits">3</span>), <span class="HLstrings">'missing_value'</span>, &amp;
		&amp; new_missing_value))
	<span class="HLcomments">! * box2</span>
	<span class="HLroutines">call</span> err(nf90_def_var(ncid, <span class="HLstrings">'eofs2'</span>, nf90_float, &amp;
	 &amp; (/dimids(<span class="HLdigits">3</span>),dimids(<span class="HLdigits">4</span>),dimids(<span class="HLdigits">6</span>)/),sstids(<span class="HLdigits">4</span>)))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, sstids(<span class="HLdigits">4</span>), <span class="HLstrings">'long_name'</span>, &amp;
		&amp; <span class="HLstrings">'SVD EOFs of SST anomaly / box <span class="HLdigits">2</span>'</span>))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, sstids(<span class="HLdigits">4</span>), <span class="HLstrings">'missing_value'</span>, &amp;
		&amp; new_missing_value))
	<span class="HLcomments">! SVD PCs</span>
	<span class="HLcomments">! * Box 1</span>
	<span class="HLroutines">call</span> err(nf90_def_var(ncid, <span class="HLstrings">'pcs1'</span>, nf90_float, &amp;
		&amp; (/dimids(<span class="HLdigits">5</span>),dimids(<span class="HLdigits">6</span>)/),sstids(<span class="HLdigits">5</span>)))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, sstids(<span class="HLdigits">5</span>), <span class="HLstrings">'long_name'</span>, &amp;
		&amp; <span class="HLstrings">'SVD EOFs of SST anomaly / box <span class="HLdigits">1</span>'</span>))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, sstids(<span class="HLdigits">5</span>), <span class="HLstrings">'units'</span>, var_units))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, sstids(<span class="HLdigits">5</span>), <span class="HLstrings">'missing_value'</span>, &amp;
		&amp; new_missing_value))
	<span class="HLcomments">! * Box 2</span>
	<span class="HLroutines">call</span> err(nf90_def_var(ncid, <span class="HLstrings">'pcs2'</span>, nf90_float, &amp;
		&amp; (/dimids(<span class="HLdigits">5</span>),dimids(<span class="HLdigits">6</span>)/),sstids(<span class="HLdigits">6</span>)))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, sstids(<span class="HLdigits">6</span>), <span class="HLstrings">'long_name'</span>, &amp;
		&amp; <span class="HLstrings">'SVD EOFs of SST anomaly / box <span class="HLdigits">2</span>'</span>))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, sstids(<span class="HLdigits">6</span>), <span class="HLstrings">'units'</span>, var_units))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, sstids(<span class="HLdigits">6</span>), <span class="HLstrings">'missing_value'</span>, &amp;
		&amp; new_missing_value))
	<span class="HLcomments">! SVD eigen values</span>
	<span class="HLroutines">call</span> err(nf90_def_var(ncid, <span class="HLstrings">'ev'</span>, nf90_float, &amp;
		&amp; dimids(<span class="HLdigits">6</span>),sstids(<span class="HLdigits">7</span>)))
	<span class="HLroutines">call</span> err(nf90_put_att(ncid, sstids(<span class="HLdigits">7</span>), <span class="HLstrings">'long_name'</span>, &amp;
		&amp; <span class="HLstrings">'Eigen values'</span>))


	<span class="HLcomments">! Values</span>
	<span class="HLroutines">call</span> err(nf90_enddef(ncid))
	<span class="HLroutines">call</span> err(nf90_put_var(ncid, varids(<span class="HLdigits">1</span>), lon1))
	<span class="HLroutines">call</span> err(nf90_put_var(ncid, varids(<span class="HLdigits">2</span>), lat1))
	<span class="HLroutines">call</span> err(nf90_put_var(ncid, varids(<span class="HLdigits">3</span>), lon2))
	<span class="HLroutines">call</span> err(nf90_put_var(ncid, varids(<span class="HLdigits">4</span>), lat2))
	<span class="HLroutines">call</span> err(nf90_put_var(ncid, varids(<span class="HLdigits">5</span>), time))
	<span class="HLroutines">call</span> err(nf90_put_var(ncid, varids(<span class="HLdigits">6</span>), &amp;
		&amp; float((/(i,i=<span class="HLdigits">1</span>,svdNkeep)/))))
	<span class="HLroutines">call</span> err(nf90_put_var(ncid, sstids(<span class="HLdigits">1</span>), sst1))
	<span class="HLroutines">call</span> err(nf90_put_var(ncid, sstids(<span class="HLdigits">2</span>), sst2))
	<span class="HLroutines">call</span> err(nf90_put_var(ncid, sstids(<span class="HLdigits">3</span>), svdEofsRec1))
	<span class="HLroutines">call</span> err(nf90_put_var(ncid, sstids(<span class="HLdigits">4</span>), svdEofsRec2))
	<span class="HLroutines">call</span> err(nf90_put_var(ncid, sstids(<span class="HLdigits">5</span>), svdPcs1))
	<span class="HLroutines">call</span> err(nf90_put_var(ncid, sstids(<span class="HLdigits">6</span>), svdPcs2))
	<span class="HLroutines">call</span> err(nf90_put_var(ncid, sstids(<span class="HLdigits">7</span>), svdEv))

	<span class="HLroutines">call</span> err(nf90_close(ncid))

<span class="HLroutines">end</span> <span class="HLroutines">program</span> example2

<span class="HLroutines">subroutine</span> err(jstatus)

	<span class="HLroutines">use</span> netcdf

	<span class="HLroutines">integer</span> :: jstatus

	<span class="HLroutines">if</span> (jstatus .ne. nf90_noerr) <span class="HLroutines">then</span>
		<span class="HLroutines">print</span> *, <span class="HLfunctions">trim</span>(nf90_strerror(jstatus))
		stop
	<span class="HLroutines">end</span> <span class="HLroutines">if</span>

<span class="HLroutines">end</span> <span class="HLroutines">subroutine</span> err

</pre></div></body></html>
